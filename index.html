<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTG Analyzer - Phân tích CTG đa chiều</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .form-section {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .results-section {
            flex: 1;
            padding: 30px;
            background: white;
            border-left: 3px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .sub-question {
            margin-left: 20px;
            margin-top: 15px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .radio-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .radio-item.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-item.selected {
            background: #e8f4fd;
            border-color: #3498db;
        }
        
        .checkbox-item input[type="checkbox"]:disabled,
        .checkbox-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .results-header {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .result-card {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .result-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        /* NICE colors */
        .result-nice-normal {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #2c3e50;
            border: 2px solid #dee2e6;
        }
        
        .result-nice-suspicious {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .result-nice-abnormal {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .result-nice-unclassified {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #17a2b8;
        }
        
        /* Japanese 5-level colors */
        .result-japanese-1 {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .result-japanese-2 {
            background: linear-gradient(135deg, #cce7ff, #b3d9ff);
            color: #004085;
            border: 2px solid #007bff;
        }
        
        .result-japanese-3 {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .result-japanese-4 {
            background: linear-gradient(135deg, #ffe4cc, #ffd6b3);
            color: #8a2c0a;
            border: 2px solid #fd7e14;
        }
        
        .result-japanese-5 {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        /* Default colors for other systems */
        .result-default {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .hidden {
            display: none;
        }
        
        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .export-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .export-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .reset-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .reset-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .image-upload {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 2px dashed #3498db;
            text-align: center;
        }
        
        .image-upload input[type="file"] {
            margin: 10px 0;
        }
        
        .image-display {
            position: sticky;
            top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #3498db;
            z-index: 100;
        }
        
        .image-display h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
        }
        
        .image-display img {
            width: 100%;
            height: auto;
            max-height: 250px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-display img:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }
        
        .image-display .no-image {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        
        /* Modal for image zoom */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }
        
        .image-modal img {
            display: block;
            margin: auto;
            max-width: 95%;
            max-height: 95%;
            margin-top: 2.5%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(255,255,255,0.1);
        }
        
        .image-modal .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .image-modal .close:hover {
            color: #ccc;
        }
        
        .image-modal .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        
        .summary-item {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #dee2e6;
        }
        
        .summary-item.selected {
            border-left-color: #3498db;
            background: #e8f4fd;
        }
        
        .summary-item strong {
            color: #2c3e50;
        }
        
        .summary-detail {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .image-display {
                position: relative;
                top: auto;
                margin-bottom: 15px;
            }
            
            .image-display img {
                max-height: 180px;
            }
            
            .image-modal img {
                max-width: 98%;
                max-height: 90%;
                margin-top: 5%;
            }
            
            .image-modal .close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CTG Analyzer</h1>
            <p>Phân tích CTG đa chiều theo các hiệp hội quốc tế</p>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <!-- Upload ảnh CTG -->
                <div class="image-upload">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">📁 Tải lên ảnh CTG</h3>
                    <p style="color: #6c757d; margin-bottom: 10px;">Chọn file ảnh CTG để tham khảo khi phân tích</p>
                    <input type="file" id="ctgImage" accept="image/*" onchange="handleImageUpload(event)">
                </div>
                
                <!-- ID Bệnh nhân -->
                <div class="form-group">
                    <h3>🏥 ID Bệnh nhân (tùy chọn)</h3>
                    <div style="margin-top: 10px;">
                        <input type="text" id="patientId" placeholder="Nhập ID bệnh nhân (nếu có)" 
                               style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                               onchange="updateProgress(); forceUpdateSummary();"
                               onfocus="this.style.borderColor='#3498db'"
                               onblur="this.style.borderColor='#e9ecef'">
                    </div>
                </div>
                
                <!-- Hiển thị ảnh CTG cố định -->
                <div class="image-display" id="imageDisplay">
                    <h4>🖼️ Ảnh CTG tham khảo (Click để phóng to)</h4>
                    <div id="stickyImageContainer">
                        <div class="no-image">Chưa có ảnh CTG. Tải lên ảnh để hiển thị tại đây.</div>
                    </div>
                </div>
                
                <!-- Modal for image zoom -->
                <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                    <span class="close" onclick="closeImageModal()">&times;</span>
                    <img id="modalImage" src="" alt="CTG Zoomed">
                    <div class="instructions">Click anywhere or press ESC to close</div>
                </div>
                
                <!-- Gò tử cung -->
                <div class="form-group">
                    <h3>1. Gò tử cung</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="normal" onchange="updateProgress(); forceUpdateSummary();">
                            < 5 cơn/10 phút
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="suspicious" onchange="updateProgress(); forceUpdateSummary();">
                            ≥ 5 cơn/10 phút
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="prolonged" onchange="updateProgress(); forceUpdateSummary();">
                            Cơn co kéo dài ≥ 2 phút
                        </label>
                    </div>
                </div>

                <!-- Tim thai căn bản -->
                <div class="form-group">
                    <h3>2. Tim thai căn bản</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="<80" onchange="handleBaselineFHR(this)">
                            < 80 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="80-100" onchange="handleBaselineFHR(this)">
                            80-100 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="100-109" onchange="handleBaselineFHR(this)">
                            100-109 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="110-160" onchange="handleBaselineFHR(this)">
                            110-160 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="160-179" onchange="handleBaselineFHR(this)">
                            160-179 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value=">180" onchange="handleBaselineFHR(this)">
                            > 180 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="unidentifiable" onchange="handleBaselineFHR(this)">
                            Không xác định được baseline
                        </label>
                    </div>
                    
                    <div id="baseline_sub_questions" class="hidden">
                        <!-- Sub questions sẽ được thêm vào đây -->
                    </div>
                </div>

                <!-- Dao động nội tại -->
                <div class="form-group">
                    <h3>3. Dao động nội tại (Variability)</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="variability" value="undetectable" onchange="handleVariability(this)">
                            Không phát hiện được (< 3 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="minimal" onchange="handleVariability(this)">
                            Tối thiểu (3-5 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="moderate" onchange="handleVariability(this)">
                            Trung bình (6-25 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="marked" onchange="handleVariability(this)">
                            Tăng (> 25 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="sinusoidal" onchange="handleVariability(this)">
                            Dạng hình sin
                        </label>
                    </div>
                    
                    <div id="variability_sub_questions" class="hidden">
                        <!-- Sub questions sẽ được thêm vào đây -->
                    </div>
                </div>

                <!-- Nhịp giảm -->
                <div class="form-group">
                    <h3>4. Nhịp giảm (Decelerations)</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="none" onchange="handleDeceleration(this)">
                            Không có nhịp giảm
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="early" onchange="handleDeceleration(this)">
                            Nhịp giảm sớm
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="variable" onchange="handleDeceleration(this)">
                            Nhịp giảm bất định (biến đổi)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="late" onchange="handleDeceleration(this)">
                            Nhịp giảm muộn
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="prolonged" onchange="handleDeceleration(this)">
                            Nhịp giảm kéo dài
                        </label>
                    </div>
                    
                    <div id="deceleration_sub_questions" class="hidden">
                        <!-- Sub questions sẽ được thêm vào đây -->
                    </div>
                </div>

                <!-- Nhịp tăng -->
                <div class="form-group">
                    <h3>5. Nhịp tăng (Accelerations)</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="acceleration" value="present" onchange="handleAcceleration(this)">
                            Có nhịp tăng
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="acceleration" value="absent" onchange="handleAcceleration(this)">
                            Không có nhịp tăng
                        </label>
                    </div>
                    
                    <div id="acceleration_sub_questions" class="hidden">
                        <!-- Sub questions sẽ được thêm vào đây -->
                    </div>
                </div>

                <div id="ctg_summary" class="form-group" style="display: none;">
                    <h3>📋 Tổng quan CTG</h3>
                    <div id="summary_content" class="summary-section">
                        <!-- Summary sẽ được thêm vào đây -->
                    </div>
                </div>

                <button class="analyze-btn" onclick="analyzeResults()">🔍 Phân tích kết quả</button>
                <button class="export-btn" id="exportBtn" onclick="exportToPDF()" disabled>📄 Xuất báo cáo PDF</button>
                <button class="save-btn" id="saveBtn" onclick="saveDataToServer()" disabled>💾 Lưu dữ liệu</button>
                <button class="reset-btn" id="resetBtn" onclick="resetForm()" disabled>🔄 Đánh giá tiếp</button>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <div class="results-section">
                <h2 class="results-header">Kết quả phân tích</h2>
                <div id="results_container">
                    <p style="text-align: center; color: #7f8c8d; font-style: italic;">
                        Vui lòng điền đầy đủ thông tin để xem kết quả phân tích
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let formData = {};
        let ctgImageData = null;
        let analysisResults = null;
        
        // Google Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMWjr1vQIKb4-uPLYXBmzOtl3WLgrzyOc47nRDrkX2l_-573-7CEGcMJaafxHQkFUm/exec';
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    ctgImageData = e.target.result;
                    const container = document.getElementById('stickyImageContainer');
                    container.innerHTML = `<img src="${e.target.result}" alt="CTG Image" onclick="openImageModal('${e.target.result}')">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        function updateProgress() {
            const totalQuestions = 5;
            let completed = 0;
            
            if (document.querySelector('input[name="uterine_contraction"]:checked')) completed++;
            if (document.querySelector('input[name="baseline_fhr"]:checked')) completed++;
            if (document.querySelector('input[name="variability"]:checked')) completed++;
            if (document.querySelector('input[name="deceleration"]:checked')) completed++;
            if (document.querySelector('input[name="acceleration"]:checked')) completed++;
            
            const percentage = (completed / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            
            // Hiển thị tổng quát CTG ngay khi có ít nhất 1 thông tin
            if (completed >= 1) {
                updateCTGSummary();
            }
        }
        
        // Hàm để force update summary
        function forceUpdateSummary() {
            setTimeout(updateCTGSummary, 100);
        }
        
        function updateCTGSummary() {
            const summaryContainer = document.getElementById('ctg_summary');
            const summaryContent = document.getElementById('summary_content');
            
            let summaryItems = [];
            
            // ID Bệnh nhân (nếu có)
            const patientId = document.getElementById('patientId').value.trim();
            if (patientId) {
                summaryItems.push(`<div class="summary-item selected"><strong>🏥 ID Bệnh nhân:</strong> ${patientId}</div>`);
            }
            
            // Gò tử cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                let status = '';
                let detail = '';
                if (contraction.value === 'normal') {
                    status = '🟢 Bình thường';
                    detail = 'Tần suất co bóp < 5 cơn/10 phút';
                } else if (contraction.value === 'suspicious') {
                    status = '🟡 Tăng';
                    detail = 'Tần suất co bóp ≥ 5 cơn/10 phút - cần theo dõi';
                } else if (contraction.value === 'prolonged') {
                    status = '🟡 Kéo dài';
                    detail = 'Cơn co kéo dài ≥ 2 phút - có thể ảnh hưởng lưu lượng máu';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Gò tử cung:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Tim thai căn bản - chi tiết hơn
            const baseline = formData.baseline_fhr;
            if (baseline) {
                let status = '';
                let detail = '';
                if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                    status = '🟢 Bình thường (110-160 bpm)';
                    detail = 'Tim thai ổn định và phù hợp tuổi thai';
                } else if (baseline === '100-109') {
                    const type = formData.baseline_100_109_type === 'new' ? 'mới xuất hiện' : 'đã có từ trước';
                    status = `🟡 Chậm nhẹ (100-109 bpm)`;
                    detail = `Tim thai chậm ${type} - cần theo dõi sát`;
                } else if (baseline === '160-179') {
                    status = '🔴 Tăng nhẹ (160-179 bpm)';
                    detail = 'Tim thai tăng - có thể do thiếu oxy, nhiễm trùng hoặc thuốc';
                    if (formData.baseline_increase_20) {
                        detail += ' • Tăng ≥20 bpm so với trước';
                    }
                } else if (baseline === '>180') {
                    status = '🔴 Tăng nặng (>180 bpm)';
                    detail = 'Tim thai tăng nghiêm trọng - cần can thiệp ngay';
                } else if (baseline === '<80' || baseline === '80-100') {
                    status = '🔴 Chậm nặng (<100 bpm)';
                    detail = 'Tim thai chậm nghiêm trọng - nguy cơ thiếu oxy thai nhi';
                } else if (baseline === 'unidentifiable') {
                    status = '🟡 Không xác định được';
                    detail = 'Không thể xác định tim thai căn bản - cần cải thiện tín hiệu';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Tim thai căn bản:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Dao động nội tại - chi tiết hơn
            const variability = formData.variability;
            if (variability) {
                let status = '';
                let detail = '';
                if (variability === 'moderate') {
                    status = '🟢 Bình thường (6-25 bpm)';
                    detail = 'Dao động nội tại tốt - hệ thần kinh thai nhi hoạt động bình thường';
                } else if (variability === 'minimal') {
                    status = '🟡/🔴 Giảm (3-5 bpm)';
                    if (formData.minimal_duration === '30-50') {
                        detail = 'Dao động giảm trong 30-50 phút - theo dõi sát';
                    } else if (formData.minimal_duration === '>50') {
                        detail = 'Dao động giảm >50 phút - nguy cơ thiếu oxy thai nhi';
                    } else {
                        detail = 'Dao động nội tại giảm - cần đánh giá thời gian';
                    }
                } else if (variability === 'marked') {
                    status = '🟡/🔴 Tăng (>25 bpm)';
                    if (formData.marked_duration === '≤10') {
                        detail = 'Dao động tăng ≤10 phút - có thể do hoạt động thai nhi';
                    } else if (formData.marked_duration === '>10') {
                        detail = 'Dao động tăng >10 phút - cần theo dõi sát';
                    } else {
                        detail = 'Dao động nội tại tăng - cần đánh giá thời gian';
                    }
                } else if (variability === 'undetectable') {
                    status = '🔴 Không phát hiện được';
                    detail = 'Mất hoàn toàn dao động nội tại - nguy cơ cao thiếu oxy thai nhi';
                } else if (variability === 'sinusoidal') {
                    status = '🔴 Dạng hình sin';
                    detail = 'Biểu đồ dạng hình sin - nguy cơ rất cao, cần can thiệp ngay';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Dao động nội tại:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Nhịp giảm - chi tiết hơn
            const decelerations = formData.decelerations || [];
            if (decelerations.length > 0) {
                if (decelerations.includes('none')) {
                    summaryItems.push(`<div class="summary-item selected"><strong>Nhịp giảm:</strong> 🟢 Không có<div class="summary-detail">Không có nhịp giảm bất thường</div></div>`);
                } else {
                    let types = [];
                    let details = [];
                    
                    if (decelerations.includes('early')) {
                        types.push('Sớm');
                        details.push('Nhịp giảm sớm - thường lành tính');
                    }
                    if (decelerations.includes('variable')) {
                        types.push('Bất định');
                        if (formData.variable_severity === 'severe') {
                            details.push('Nhịp giảm bất định nặng - nguy cơ thiếu oxy');
                        } else {
                            details.push('Nhịp giảm bất định nhẹ');
                        }
                        if (formData.variable_repetitive === 'yes') {
                            details.push('• Lặp lại');
                            if (formData.worrying_features && formData.worrying_features.length > 0) {
                                details.push('• Có đặc điểm đáng ngại');
                            }
                        }
                    }
                    if (decelerations.includes('late')) {
                        types.push('Muộn');
                        if (formData.late_severity === 'severe') {
                            details.push('Nhịp giảm muộn nặng - thiếu oxy thai nhi');
                        } else {
                            details.push('Nhịp giảm muộn - nguy cơ thiếu oxy');
                        }
                        if (formData.late_repetitive === 'yes') {
                            details.push('• Lặp lại');
                        }
                    }
                    if (decelerations.includes('prolonged')) {
                        types.push('Kéo dài');
                        if (formData.prolonged_duration === '>3') {
                            details.push('Kéo dài >3 phút - tim thai chậm cấp');
                        } else {
                            details.push('Nhịp giảm kéo dài');
                        }
                    }
                    
                    summaryItems.push(`<div class="summary-item selected"><strong>Nhịp giảm:</strong> 🟡/🔴 ${types.join(', ')}<div class="summary-detail">${details.join(' ')}</div></div>`);
                }
            }
            
            // Nhịp tăng
            if (formData.acceleration) {
                let status = '';
                let detail = '';
                if (formData.acceleration === 'present') {
                    status = '🟢 Có';
                    detail = 'Có nhịp tăng - dấu hiệu tốt của thai nhi khỏe mạnh';
                    if (formData.acceleration_disappear === 'yes') {
                        detail += ' • Biến mất sau nhịp giảm - có thể do thiếu oxy';
                    }
                } else {
                    status = '🟡 Không có';
                    detail = 'Vắng mặt nhịp tăng - cần theo dõi sát';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Nhịp tăng:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Thêm thông tin so sánh thời gian
            if (formData.time_comparison) {
                let detail = '';
                if (formData.time_comparison === 'baseline_longer') {
                    detail = 'Thời gian ở tim thai căn bản dài hơn thời gian trong nhịp giảm - tình trạng tương đối ổn định';
                } else {
                    detail = 'Thời gian trong nhịp giảm dài hơn thời gian ở baseline - nguy cơ thiếu oxy';
                }
                summaryItems.push(`<div class="summary-item"><strong>So sánh thời gian:</strong><div class="summary-detail">${detail}</div></div>`);
            }
            
            summaryContent.innerHTML = summaryItems.join('');
            summaryContainer.style.display = 'block';
        }
        
        function handleBaselineFHR(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('baseline_sub_questions');
            
            formData.baseline_fhr = value;
            
            let subHTML = '';
            
            if (value === '100-109') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai 100-109 bpm này:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="baseline_100_109_type" value="new" onchange="formData.baseline_100_109_type = this.value; updateProgress(); forceUpdateSummary(); showStepDownQuestion();">
                                Mới xuất hiện (trước đó > 109 bpm)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="baseline_100_109_type" value="existing" onchange="formData.baseline_100_109_type = this.value; updateProgress(); forceUpdateSummary(); hideStepDownQuestion();">
                                Đã có từ trước (băng ghi trước cũng 100-109 bpm)
                            </label>
                        </div>
                        <div id="step_down_sub" class="hidden">
                            <!-- Step down question sẽ được thêm vào đây -->
                        </div>
                    </div>
                `;
            } else if (value === '110-160') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai có ổn định và phù hợp tuổi thai không?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="baseline_stable" value="yes" onchange="formData.baseline_stable = this.value; updateProgress(); forceUpdateSummary();">
                                Có - ổn định và phù hợp
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="baseline_stable" value="no" onchange="handleBaselineUnstable(this)">
                                Không - có thay đổi
                            </label>
                        </div>
                        <div id="baseline_unstable_sub" class="hidden">
                            <!-- Sub questions cho trường hợp không ổn định -->
                        </div>
                    </div>
                `;
            } else if (value === '<80' || value === '80-100') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai chậm này có đặc điểm gì?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="bradycardia_step_down" value="yes" onchange="formData.bradycardia_step_down = this.value; updateProgress(); forceUpdateSummary();">
                                Có step down (giảm dần so với băng ghi trước)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="bradycardia_step_down" value="no" onchange="formData.bradycardia_step_down = this.value; updateProgress(); forceUpdateSummary();">
                                Không có step down
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (value === '160-179' || value === '>180') {
                subHTML += `
                    <div class="sub-question">
                        <h4>Tăng tim thai này:</h4>
                        <p style="color: #e74c3c; font-weight: bold;">⚠️ Tim thai > 160 bpm = Tự động coi là tăng tim thai căn bản</p>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="baseline_increase_10" value="yes" onchange="formData.baseline_increase_10 = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();" checked disabled>
                                Tăng > 10% so với băng ghi trước đó (Tự động)
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="baseline_increase_20" value="yes" onchange="formData.baseline_increase_20 = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                                Tăng ≥ 20 bpm so với băng ghi trước đó
                            </label>
                        </div>
                        <div id="sleep_cycle_sub" class="hidden">
                            <!-- Sleep cycle question sẽ được thêm vào đây -->
                        </div>
                    </div>
                `;
                // Tự động set giá trị
                formData.baseline_increase_10 = true;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function showStepDownQuestion() {
            const subContainer = document.getElementById('step_down_sub');
            const subHTML = `
                <div class="sub-question">
                    <h4>Tim thai 100-109 mới xuất hiện này:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="baseline_step_down" value="yes" onchange="formData.baseline_step_down = this.value; updateProgress(); forceUpdateSummary();">
                            Có step down (giảm so với băng ghi trước)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_step_down" value="no" onchange="formData.baseline_step_down = this.value; updateProgress(); forceUpdateSummary();">
                            Không có step down
                        </label>
                    </div>
                </div>
            `;
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
        }
        
        function hideStepDownQuestion() {
            const subContainer = document.getElementById('step_down_sub');
            subContainer.classList.add('hidden');
            formData.baseline_step_down = null;
        }
        
        function toggleSleepCycleQuestion() {
            const hasIncrease = formData.baseline_increase_10 || formData.baseline_increase_20 || 
                              formData.baseline_increase_10_normal || formData.baseline_increase_20_normal;
            
            const subContainer = document.getElementById('sleep_cycle_sub');
            
            if (hasIncrease) {
                const subHTML = `
                    <div class="sub-question">
                        <h4>Thai nhi còn chu kỳ tỉnh ngủ không?</h4>
                        <p style="color: #6c757d; font-size: 0.9em;">Mô tả: mất nhịp tăng và có nhịp tăng xen kẽ tương ứng với chu kỳ ngủ và tỉnh</p>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="sleep_cycle" value="yes" onchange="formData.sleep_cycle = this.value; updateProgress(); forceUpdateSummary();">
                                Có - vẫn còn chu kỳ tỉnh ngủ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="sleep_cycle" value="no" onchange="formData.sleep_cycle = this.value; updateProgress(); forceUpdateSummary();">
                                Không - mất chu kỳ tỉnh ngủ
                            </label>
                        </div>
                    </div>
                `;
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
                formData.sleep_cycle = null;
            }
        }
        
        function handleBaselineUnstable(element) {
            const subContainer = document.getElementById('baseline_unstable_sub');
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Loại thay đổi:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="baseline_increase_10_normal" value="yes" onchange="formData.baseline_increase_10_normal = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                            Tăng > 10% so với băng ghi trước đó
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="baseline_increase_20_normal" value="yes" onchange="formData.baseline_increase_20_normal = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                            Tăng ≥ 20 bpm so với băng ghi trước đó
                        </label>
                    </div>
                    <div id="sleep_cycle_sub" class="hidden">
                        <!-- Sleep cycle question sẽ được thêm vào đây -->
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariability(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('variability_sub_questions');
            
            formData.variability = value;
            
            let subHTML = '';
            
            if (value === 'minimal') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Thời gian dao động < 5 bpm:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="minimal_duration" value="30-50" onchange="formData.minimal_duration = this.value; updateProgress(); forceUpdateSummary();">
                                30-50 phút
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="minimal_duration" value=">50" onchange="formData.minimal_duration = this.value; updateProgress(); forceUpdateSummary();">
                                > 50 phút
                            </label>
                        </div>
                    </div>
                `;
            } else if (value === 'marked') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Thời gian dao động > 25 bpm:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="marked_duration" value="≤10" onchange="formData.marked_duration = this.value; updateProgress(); forceUpdateSummary();">
                                ≤ 10 phút
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="marked_duration" value=">10" onchange="formData.marked_duration = this.value; updateProgress(); forceUpdateSummary();">
                                > 10 phút
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function handleDeceleration(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('deceleration_sub_questions');
            
            // Handle checkbox logic
            if (element.checked) {
                if (value === 'none') {
                    // Uncheck all other decelerations if "none" is selected
                    document.querySelectorAll('input[name="deceleration"]:not([value="none"])').forEach(cb => {
                        cb.checked = false;
                    });
                } else {
                    // Uncheck "none" if any other deceleration is selected
                    document.querySelector('input[name="deceleration"][value="none"]').checked = false;
                }
            }
            
            // Collect all checked decelerations
            const checkedDecelerations = Array.from(document.querySelectorAll('input[name="deceleration"]:checked'))
                .map(cb => cb.value);
            
            formData.decelerations = checkedDecelerations;
            
            let subHTML = '';
            
            if (checkedDecelerations.includes('variable')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nhịp giảm bất định:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_severity" value="mild" onchange="handleVariableDeceleration(this)">
                                Nhẹ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_severity" value="severe" onchange="handleVariableDeceleration(this)">
                                Nặng (điểm thấp nhất < 70 bpm và > 30s hoặc 70-80 bpm và > 60s)
                            </label>
                        </div>
                        <div id="variable_sub" class="hidden"></div>
                    </div>
                `;
            }
            
            if (checkedDecelerations.includes('late')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nhịp giảm muộn:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="late_severity" value="mild" onchange="formData.late_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nhẹ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="late_severity" value="severe" onchange="formData.late_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nặng (> 15 bpm từ baseline)
                            </label>
                        </div>
                        <div class="sub-question">
                            <h4>Tính chất:</h4>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="late_repetitive" value="yes" onchange="handleLateRepetitive(this)">
                                    Lặp lại
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="late_repetitive" value="no" onchange="formData.late_repetitive = this.value; updateProgress(); forceUpdateSummary();">
                                    Không lặp lại
                                </label>
                            </div>
                            <div id="late_repetitive_sub" class="hidden"></div>
                        </div>
                    </div>
                `;
            }
            
            if (checkedDecelerations.includes('prolonged')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nhịp giảm kéo dài:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="prolonged_severity" value="mild" onchange="formData.prolonged_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nhẹ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="prolonged_severity" value="severe" onchange="formData.prolonged_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nặng (điểm thấp nhất < 80 bpm)
                            </label>
                        </div>
                        <div class="sub-question">
                            <h4>Thời gian:</h4>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value="<2" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    < 2 phút
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value="2-3" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    2-3 phút
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value=">3" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    > 3 phút
                                </label>
                            </div>
                            <div class="sub-question">
                                <h4>Thời gian xuất hiện (cho FIGO):</h4>
                                <div class="radio-group">
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value="<20" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        < 20 phút
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value="20-30" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        20-30 phút
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value=">30" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        > 30 phút
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Thêm câu hỏi về thời gian trong nhịp giảm vs baseline
            if (checkedDecelerations.some(d => ['variable', 'late', 'prolonged'].includes(d))) {
                subHTML += `
                    <div class="sub-question">
                        <h4>So sánh thời gian:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="time_comparison" value="baseline_longer" onchange="formData.time_comparison = this.value; updateProgress(); forceUpdateSummary();">
                                Thời gian ở tim thai căn bản dài hơn
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="time_comparison" value="deceleration_longer" onchange="formData.time_comparison = this.value; updateProgress(); forceUpdateSummary();">
                                Thời gian trong nhịp giảm dài hơn
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function handleVariableDeceleration(element) {
            const value = element.value;
            const subContainer = document.getElementById('variable_sub');
            
            formData.variable_severity = value;
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Tính chất:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="variable_repetitive" value="yes" onchange="handleVariableRepetitive(this)">
                            Lặp lại
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variable_repetitive" value="no" onchange="handleVariableNonRepetitive(this)">
                            Không lặp lại
                        </label>
                    </div>
                    <div id="variable_repetitive_sub" class="hidden"></div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariableRepetitive(element) {
            const subContainer = document.getElementById('variable_repetitive_sub');
            formData.variable_repetitive = 'yes';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Đặc điểm đáng ngại:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="duration_>60s" onchange="updateWorryingFeatures()">
                            Kéo dài > 60 giây
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="reduced_variability" onchange="updateWorryingFeatures()">
                            Giảm dao động trong nhịp giảm
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="slow_return" onchange="updateWorryingFeatures()">
                            Trở về baseline chậm hoặc không trở về
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="no_shouldering" onchange="updateWorryingFeatures()">
                            Mất dạng vai (shouldering)
                        </label>
                    </div>
                    <div class="sub-question">
                        <h4>Thời gian xuất hiện:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_duration" value="<30" onchange="formData.variable_duration = this.value; forceUpdateSummary();">
                                < 30 phút
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_duration" value="≥30" onchange="formData.variable_duration = this.value; forceUpdateSummary();">
                                ≥ 30 phút
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariableNonRepetitive(element) {
            const subContainer = document.getElementById('variable_repetitive_sub');
            formData.variable_repetitive = 'no';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Đặc điểm đáng ngại:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="duration_>60s" onchange="updateWorryingFeaturesNonRep()">
                            Kéo dài > 60 giây
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="reduced_variability" onchange="updateWorryingFeaturesNonRep()">
                            Giảm dao động trong nhịp giảm
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="slow_return" onchange="updateWorryingFeaturesNonRep()">
                            Trở về baseline chậm hoặc không trở về
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="no_shouldering" onchange="updateWorryingFeaturesNonRep()">
                            Mất dạng vai (shouldering)
                        </label>
                    </div>
                    <div class="sub-question">
                        <h4>Thời gian xuất hiện:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_nonrep_duration" value="<30" onchange="formData.variable_nonrep_duration = this.value; forceUpdateSummary();">
                                < 30 phút
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_nonrep_duration" value="≥30" onchange="formData.variable_nonrep_duration = this.value; forceUpdateSummary();">
                                ≥ 30 phút
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleLateRepetitive(element) {
            const subContainer = document.getElementById('late_repetitive_sub');
            formData.late_repetitive = 'yes';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Thời gian:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="late_duration" value="<30" onchange="formData.late_duration = this.value; forceUpdateSummary();">
                            < 30 phút
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="late_duration" value="≥30" onchange="formData.late_duration = this.value; forceUpdateSummary();">
                            ≥ 30 phút
                        </label>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function updateWorryingFeatures() {
            const checkedFeatures = Array.from(document.querySelectorAll('input[name="worrying_features"]:checked'))
                .map(cb => cb.value);
            formData.worrying_features = checkedFeatures;
            updateProgress();
            forceUpdateSummary();
        }
        
        function updateWorryingFeaturesNonRep() {
            const checkedFeatures = Array.from(document.querySelectorAll('input[name="worrying_features_nonrep"]:checked'))
                .map(cb => cb.value);
            formData.worrying_features_nonrep = checkedFeatures;
            updateProgress();
            forceUpdateSummary();
        }
        
        function handleAcceleration(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('acceleration_sub_questions');
            
            formData.acceleration = value;
            
            let subHTML = '';
            
            if (value === 'present') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Nhịp tăng có biến mất sau nhịp giảm không?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="acceleration_disappear" value="yes" onchange="formData.acceleration_disappear = this.value; updateProgress(); forceUpdateSummary();">
                                Có - biến mất sau nhịp giảm
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="acceleration_disappear" value="no" onchange="formData.acceleration_disappear = this.value; updateProgress(); forceUpdateSummary();">
                                Không - vẫn có sau nhịp giảm
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function analyzeResults() {
            // Reset unclassified flag
            formData.nice_unclassified = false;
            
            const results = {
                nice: analyzeNICE(),
                acog: analyzeACOG(),
                rcog: analyzeRCOG(),
                figo: analyzeFIGO(),
                japanese5: analyzeJapanese5(),
                physiological: analyzePhysiological()
            };
            
            analysisResults = results;
            displayResults(results);
            
            // Enable export, save and reset buttons
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        }
        
        async function saveDataToServer() {
            if (!analysisResults) {
                showStatusMessage('Vui lòng phân tích kết quả trước khi lưu dữ liệu', 'error');
                return;
            }
            
            // Xác nhận trước khi gửi
            const patientId = document.getElementById('patientId').value.trim();
            let confirmMessage = 'Bạn có chắc chắn muốn lưu dữ liệu CTG này lên Google Sheets?\n\nDữ liệu bao gồm:\n✅ Kết quả 6 hệ thống phân loại\n✅ Thông tin CTG chi tiết\n✅ Ảnh CTG (nếu có) → Upload lên Google Drive';
            if (patientId) {
                confirmMessage += `\n✅ ID Bệnh nhân: ${patientId}`;
            }
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            // Hiển thị trạng thái đang gửi
            showStatusMessage('⏳ Đang lưu dữ liệu và upload ảnh lên Google Drive...', 'loading');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Chuẩn bị dữ liệu gửi đầy đủ
                const payload = {
                    timestamp: new Date().toISOString(),
                    patientId: patientId || '',
                    formData: formData,
                    analysisResults: analysisResults,
                    ctgImage: ctgImageData,
                    summary: generateDataSummary(),
                    detailedResults: generateDetailedResults()
                };
                
                console.log('Sending payload:', payload);
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = '✅ Lưu dữ liệu thành công!';
                    if (result.imageUrl && result.imageUrl !== 'Không có ảnh') {
                        message += `\n🖼️ Ảnh CTG: ${result.imageUrl}`;
                    }
                    if (patientId) {
                        message += `\n🏥 ID Bệnh nhân: ${patientId}`;
                    }
                    showStatusMessage(message, 'success');
                } else {
                    showStatusMessage('❌ Lỗi: ' + (result.error || 'Không thể lưu dữ liệu'), 'error');
                }
                
            } catch (error) {
                console.error('Error saving data:', error);
                
                // Fallback method
                try {
                    const payload = {
                        timestamp: new Date().toISOString(),
                        patientId: patientId || '',
                        formData: formData,
                        analysisResults: analysisResults,
                        ctgImage: ctgImageData,
                        summary: generateDataSummary(),
                        detailedResults: generateDetailedResults()
                    };
                    
                    const formData_send = new FormData();
                    formData_send.append('data', JSON.stringify(payload));
                    
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData_send,
                        mode: 'no-cors'
                    });
                    
                    showStatusMessage('✅ Dữ liệu đã được gửi! (Kiểm tra Google Sheets để xác nhận)', 'success');
                    
                } catch (error2) {
                    showStatusMessage(`❌ Lỗi kết nối: ${error.message}\n\n🔧 Kiểm tra:\n1. Apps Script đã deploy chưa?\n2. Sheet ID đã đúng chưa?\n3. Đã authorize quyền Drive & Sheets chưa?`, 'error');
                }
            } finally {
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        function generateDetailedResults() {
            // Tạo dữ liệu chi tiết cho 6 hệ thống phân loại
            const results = {};
            
            if (analysisResults.nice) {
                results.nice = analysisResults.nice.classification;
            }
            if (analysisResults.figo) {
                results.figo = analysisResults.figo.classification;
            }
            if (analysisResults.rcog) {
                results.rcog = analysisResults.rcog.classification;
            }
            if (analysisResults.acog) {
                results.acog = analysisResults.acog.classification;
            }
            if (analysisResults.japanese5) {
                results.japanese5 = analysisResults.japanese5.classification;
            }
            if (analysisResults.physiological) {
                results.physiological = analysisResults.physiological.classification;
            }
            
            // Xử lý gò tử cung: normal hoặc hyper
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                if (contraction.value === 'normal') {
                    results.uterine_contraction = 'normal';
                } else {
                    results.uterine_contraction = 'hyper'; // suspicious hoặc prolonged = hyper
                }
            }
            
            return results;
        }
        
        // Callback function cho JSONP
        window.handleResponse = function(response) {
            if (response && response.success) {
                showStatusMessage('✅ Lưu dữ liệu thành công!', 'success');
            } else {
                showStatusMessage('⚠️ Dữ liệu đã được gửi nhưng không nhận được xác nhận', 'success');
            }
        };
        
        function generateDataSummary() {
            let summary = {};
            
            // Gò tử cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                summary.uterine_contraction = contraction.value;
            }
            
            // Tim thai căn bản
            if (formData.baseline_fhr) {
                summary.baseline_fhr = formData.baseline_fhr;
                if (formData.baseline_stable) summary.baseline_stable = formData.baseline_stable;
                if (formData.baseline_100_109_type) summary.baseline_100_109_type = formData.baseline_100_109_type;
            }
            
            // Dao động nội tại
            if (formData.variability) {
                summary.variability = formData.variability;
                if (formData.minimal_duration) summary.minimal_duration = formData.minimal_duration;
                if (formData.marked_duration) summary.marked_duration = formData.marked_duration;
            }
            
            // Nhịp giảm
            if (formData.decelerations) {
                summary.decelerations = formData.decelerations;
                if (formData.variable_severity) summary.variable_severity = formData.variable_severity;
                if (formData.late_severity) summary.late_severity = formData.late_severity;
                if (formData.prolonged_severity) summary.prolonged_severity = formData.prolonged_severity;
            }
            
            // Nhịp tăng
            if (formData.acceleration) {
                summary.acceleration = formData.acceleration;
                if (formData.acceleration_disappear) summary.acceleration_disappear = formData.acceleration_disappear;
            }
            
            return summary;
        }
        
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Tự động ẩn sau 5 giây (trừ loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function resetForm() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu và bắt đầu đánh giá mới?')) {
                // Reset form data
                formData = {};
                ctgImageData = null;
                analysisResults = null;
                
                // Reset all form inputs
                document.querySelectorAll('input[type="radio"]').forEach(input => {
                    input.checked = false;
                    input.closest('.radio-item').classList.remove('selected');
                });
                
                document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                    input.checked = false;
                    input.closest('.checkbox-item').classList.remove('selected');
                });
                
                // Reset file inputs and text inputs
                document.getElementById('ctgImage').value = '';
                document.getElementById('patientId').value = '';
                
                // Reset image display
                const container = document.getElementById('stickyImageContainer');
                container.innerHTML = '<div class="no-image">Chưa có ảnh CTG. Tải lên ảnh để hiển thị tại đây.</div>';
                
                // Hide all sub-questions
                document.querySelectorAll('[id$="_sub_questions"]').forEach(element => {
                    element.classList.add('hidden');
                    element.innerHTML = '';
                });
                
                // Reset progress bar
                document.getElementById('progressFill').style.width = '0%';
                
                // Hide summary
                document.getElementById('ctg_summary').style.display = 'none';
                
                // Reset results display
                document.getElementById('results_container').innerHTML = `
                    <p style="text-align: center; color: #7f8c8d; font-style: italic;">
                        Vui lòng điền đầy đủ thông tin để xem kết quả phân tích
                    </p>
                `;
                
                // Hide status message
                document.getElementById('statusMessage').style.display = 'none';
                
                // Disable buttons
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('resetBtn').disabled = true;
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function analyzeNICE() {
            let scores = { white: 0, yellow: 0, red: 0 };
            let details = [];
            let reasoningDetails = [];
            
            // Gò tử cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked')?.value;
            if (contraction === 'normal') {
                scores.white++;
                reasoningDetails.push('Gò tử cung < 5 cơn/10 phút = Bình thường (Trắng)');
            } else if (contraction === 'suspicious' || contraction === 'prolonged') {
                scores.yellow++;
                reasoningDetails.push('Gò tử cung ≥ 5 cơn/10 phút hoặc kéo dài ≥ 2 phút = Nghi ngờ (Vàng)');
            }
            
            // Tim thai căn bản
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                scores.white++;
                reasoningDetails.push('Tim thai 110-160 bpm ổn định, phù hợp tuổi thai = Bình thường (Trắng)');
            } else if (baseline === '100-109' && formData.baseline_100_109_type === 'existing') {
                scores.white++;
                reasoningDetails.push('Tim thai 100-109 bpm (đã có từ trước) = Bình thường (Trắng)');
            } else if (baseline === '100-109' && formData.baseline_100_109_type === 'new') {
                scores.yellow++;
                reasoningDetails.push('Tim thai 100-109 bpm (mới xuất hiện) = Nghi ngờ (Vàng)');
            } else if (baseline === '110-160' && (formData.baseline_increase_20_normal)) {
                scores.yellow++;
                reasoningDetails.push('Tim thai tăng ≥ 20 bpm từ đầu chuyển dạ = Nghi ngờ (Vàng)');
            } else if (baseline === '<80' || baseline === '80-100') {
                scores.red++;
                reasoningDetails.push('Tim thai < 100 bpm = Bất thường (Đỏ)');
            } else if (baseline === '160-179' || baseline === '>180') {
                scores.red++;
                reasoningDetails.push('Tim thai > 160 bpm = Bất thường (Đỏ)');
            } else if (baseline === 'unidentifiable') {
                scores.yellow++;
                reasoningDetails.push('Không xác định được baseline = Nghi ngờ (Vàng)');
            }
            
            // Dao động nội tại
            const variability = formData.variability;
            if (variability === 'moderate') {
                scores.white++;
                reasoningDetails.push('Dao động nội tại 5-25 bpm = Bình thường (Trắng)');
            } else if (variability === 'minimal' && formData.minimal_duration === '30-50') {
                scores.yellow++;
                reasoningDetails.push('Dao động < 5 bpm trong 30-50 phút = Nghi ngờ (Vàng)');
            } else if (variability === 'marked' && formData.marked_duration === '≤10') {
                scores.yellow++;
                reasoningDetails.push('Dao động > 25 bpm trong ≤ 10 phút = Nghi ngờ (Vàng)');
            } else if (variability === 'minimal' && formData.minimal_duration === '>50') {
                scores.red++;
                reasoningDetails.push('Dao động < 5 bpm > 50 phút = Bất thường (Đỏ)');
            } else if (variability === 'marked' && formData.marked_duration === '>10') {
                scores.red++;
                reasoningDetails.push('Dao động > 25 bpm > 10 phút = Bất thường (Đỏ)');
            } else if (variability === 'sinusoidal') {
                scores.red++;
                reasoningDetails.push('Dao động dạng hình sin = Bất thường (Đỏ)');
            } else if (variability === 'undetectable') {
                scores.red++;
                reasoningDetails.push('Dao động không phát hiện được = Bất thường (Đỏ)');
            }
            
            // Nhịp giảm (logic phức tạp)
            analyzeDecelerationsNICE(scores, reasoningDetails);
            
            // Kết luận NICE
            let classification, color, management;
            if (formData.nice_unclassified) {
                classification = 'KHÔNG PHÂN LOẠI ĐƯỢC';
                color = 'unclassified';
                management = 'Cần đánh giá lâm sàng và áp dụng các tiêu chuẩn khác';
                details.push('Có trường hợp không phân loại được trong NICE 2022');
            } else if (scores.red > 0 || scores.yellow >= 2) {
                classification = 'BẤT THƯỜNG';
                color = 'abnormal';
                management = 'Đánh giá toàn diện bao gồm mẹ; hồi sinh, hồi sức; cân nhắc kích thích đầu thai, loại trừ tai biến cấp và cân nhắc CDTK ngay';
                details.push('1 tiêu chí đỏ hoặc ≥ 2 tiêu chí vàng → Cần can thiệp ngay');
            } else if (scores.yellow === 1) {
                classification = 'NGHI NGỜ';
                color = 'suspicious';
                management = 'Đánh giá toàn diện, bao gồm cả mẹ; hỏi căn nguyên, hồi sức; cân nhắc kích thích đầu thai hoặc thúc đẩy/chuyển dạ/CTDK';
                details.push('1 tiêu chí vàng → Đánh giá toàn diện, theo dõi sát');
            } else {
                classification = 'BÌNH THƯỜNG';
                color = 'normal';
                management = 'Tiếp tục theo dõi';
                details.push('4 tiêu chí đều trắng → Tiếp tục theo dõi');
            }
            
            details.push(`🔧 Xử trí: ${management}`);
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'NICE 2022'
            };
        }
        
        function analyzeDecelerationsNICE(scores, details) {
            const decelerations = formData.decelerations || [];
            
            if (decelerations.includes('none') || decelerations.includes('early')) {
                scores.white++;
                details.push('Nhịp giảm: Bình thường (không có hoặc chỉ có nhịp giảm sớm)');
                return;
            }
            
            let hasUnclassified = false;
            
            if (decelerations.includes('variable')) {
                if (formData.variable_repetitive === 'yes') {
                    if (formData.worrying_features && formData.worrying_features.length > 0) {
                        if (formData.variable_duration === '<30') {
                            scores.yellow++;
                            details.push('Nhịp giảm: Nghi ngờ (bất định lặp lại có đặc điểm đáng ngại < 30 phút)');
                        } else {
                            scores.red++;
                            details.push('Nhịp giảm: Bất thường (bất định lặp lại có đặc điểm đáng ngại ≥ 30 phút)');
                        }
                    } else {
                        // Trường hợp unclassified: Recurrent variable decelerations không có concerning features
                        hasUnclassified = true;
                        details.push('Nhịp giảm: Không phân loại được (bất định lặp lại không có đặc điểm đáng ngại)');
                    }
                } else if (formData.variable_repetitive === 'no') {
                    if (formData.worrying_features_nonrep && formData.worrying_features_nonrep.length > 0) {
                        if (formData.variable_nonrep_duration === '<30') {
                            // Trường hợp unclassified: Variable decelerations with concerning features, non-recurrent, < 30 phút
                            hasUnclassified = true;
                            details.push('Nhịp giảm: Không phân loại được (bất định không lặp lại có đặc điểm đáng ngại < 30 phút)');
                        } else {
                            scores.yellow++;
                            details.push('Nhịp giảm: Nghi ngờ (bất định không lặp lại có đặc điểm đáng ngại ≥ 30 phút)');
                        }
                    } else {
                        scores.white++;
                        details.push('Nhịp giảm: Bình thường (bất định không có đặc điểm đáng ngại)');
                    }
                }
            }
            
            if (decelerations.includes('late')) {
                if (formData.late_repetitive === 'yes') {
                    if (formData.late_duration === '<20') {
                        scores.yellow++;
                        details.push('Nhịp giảm: Nghi ngờ (muộn lặp lại < 30 phút)');
                    } else if (formData.late_duration === '20-30') {
                        scores.yellow++;
                        details.push('Nhịp giảm: Nghi ngờ (muộn lặp lại 20-30 phút)');
                    } else {
                        scores.red++;
                        details.push('Nhịp giảm: Bất thường (muộn lặp lại > 30 phút)');
                    }
                } else if (formData.late_repetitive === 'no') {
                    // Trường hợp unclassified: Late decelerations không lặp lại
                    hasUnclassified = true;
                    details.push('Nhịp giảm: Không phân loại được (nhịp giảm muộn không lặp lại)');
                }
            }
            
            if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>3') {
                    scores.red++;
                    details.push('Nhịp giảm: Bất thường (kéo dài > 3 phút = tim thai chậm cấp)');
                }
            }
            
            // Nếu có trường hợp unclassified, đánh dấu để xử lý riêng
            if (hasUnclassified) {
                formData.nice_unclassified = true;
            }
        }
        
        function analyzeACOG() {
            // Nhóm I: Tất cả bình thường
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            
            let reasoningDetails = [];
            
            const hasNormalBaseline = baseline === '110-160' && formData.baseline_stable === 'yes';
            const hasModerateVariability = variability === 'moderate';
            const hasNoLateOrVariable = !decelerations.includes('late') && !decelerations.includes('variable');
            
            // Nhóm III: Các tiêu chí nghiêm trọng
            const hasAbsentVariability = variability === 'undetectable';
            const hasSinusoidal = variability === 'sinusoidal';
            const hasBradycardia = baseline === '<80' || baseline === '80-100' || baseline === '100-109'; // Cập nhật: < 110 bpm
            const hasRecurrentLate = decelerations.includes('late') && formData.late_repetitive === 'yes';
            const hasRecurrentVariable = decelerations.includes('variable') && formData.variable_repetitive === 'yes';
            
            let classification, color;
            
            if ((hasAbsentVariability && (hasRecurrentLate || hasRecurrentVariable || hasBradycardia)) || hasSinusoidal) {
                classification = 'NHÓM III';
                color = 'abnormal';
                if (hasAbsentVariability && hasBradycardia) {
                    reasoningDetails.push('Không có dao động nội tại + tim thai < 110 bpm (nhịp chậm) = Nhóm III');
                } else if (hasAbsentVariability && (hasRecurrentLate || hasRecurrentVariable)) {
                    reasoningDetails.push('Không có dao động nội tại + nhịp giảm lặp lại = Nhóm III');
                } else if (hasSinusoidal) {
                    reasoningDetails.push('Biểu đồ dạng hình sin = Nhóm III');
                }
                reasoningDetails.push('Nhóm III: Cần can thiệp ngay lập tức');
            } else if (hasNormalBaseline && hasModerateVariability && hasNoLateOrVariable) {
                classification = 'NHÓM I';
                color = 'normal';
                reasoningDetails.push('Tim thai 110-160 bpm + dao động trung bình + không có nhịp giảm muộn/bất định = Nhóm I');
                reasoningDetails.push('Nhóm I: Thai nhi khỏe mạnh, theo dõi bình thường');
            } else {
                classification = 'NHÓM II';
                color = 'suspicious';
                reasoningDetails.push('Không đạt tiêu chí Nhóm I và không có dấu hiệu Nhóm III = Nhóm II');
                reasoningDetails.push('Nhóm II: Cần theo dõi sát, đánh giá thêm');
                
                // Thêm chi tiết cho Nhóm II
                if (hasBradycardia) {
                    reasoningDetails.push('• Tim thai < 110 bpm (nhịp chậm) - theo dõi sát');
                }
            }
            
            return {
                classification,
                color,
                details: reasoningDetails,
                system: 'ACOG 2009'
            };
        }
        
        function analyzeRCOG() {
            let reassuring = 0;
            let nonReassuring = 0;
            let abnormal = 0;
            let details = [];
            let reasoningDetails = [];
            
            // Tim thai căn bản
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                reassuring++;
                reasoningDetails.push('Tim thai 110-160 bpm ổn định = An tâm');
            } else if (baseline === '100-109' || baseline === '160-179') {
                nonReassuring++;
                reasoningDetails.push('Tim thai 100-109 bpm hoặc 160-179 bpm = Không an tâm');
            } else if (baseline === '<80' || baseline === '80-100' || baseline === '>180' || baseline === 'unidentifiable') {
                abnormal++;
                reasoningDetails.push('Tim thai < 100 bpm hoặc > 180 bpm hoặc không xác định được = Bất thường');
            } else {
                nonReassuring++;
                reasoningDetails.push('Tim thai không ổn định = Không an tâm');
            }
            
            // Dao động nội tại
            const variability = formData.variability;
            if (variability === 'moderate' || variability === 'marked') {
                reassuring++;
                reasoningDetails.push('Dao động ≥ 5 bpm = An tâm');
            } else if (variability === 'minimal') {
                if (formData.minimal_duration === '>50') {
                    abnormal++;
                    reasoningDetails.push('Dao động < 5 bpm trong ≥ 90 phút = Bất thường');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Dao động < 5 bpm trong 40-90 phút = Không an tâm');
                }
            } else if (variability === 'undetectable') {
                abnormal++;
                reasoningDetails.push('Dao động không phát hiện được = Bất thường');
            } else if (variability === 'sinusoidal') {
                abnormal++;
                reasoningDetails.push('Dao động hình sin ≥ 10 phút = Bất thường');
            }
            
            // Nhịp giảm
            const decelerations = formData.decelerations || [];
            if (decelerations.includes('none')) {
                reassuring++;
                reasoningDetails.push('Không có nhịp giảm = An tâm');
            } else if (decelerations.includes('early')) {
                nonReassuring++;
                reasoningDetails.push('Nhịp giảm sớm = Không an tâm');
            } else if (decelerations.includes('variable')) {
                // Nhịp giảm biến đổi có dấu hiệu đáng ngại = không điển hình = bất thường
                const hasWorryingFeatures = (formData.worrying_features && formData.worrying_features.length > 0) ||
                                          (formData.worrying_features_nonrep && formData.worrying_features_nonrep.length > 0);
                
                if (formData.variable_severity === 'severe' || hasWorryingFeatures) {
                    abnormal++;
                    reasoningDetails.push('Nhịp giảm biến đổi không điển hình (nặng hoặc có đặc điểm đáng ngại) = Bất thường');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Nhịp giảm biến đổi điển hình = Không an tâm');
                }
            } else if (decelerations.includes('late')) {
                abnormal++;
                reasoningDetails.push('Nhịp giảm muộn = Bất thường');
            } else if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>3') {
                    abnormal++;
                    reasoningDetails.push('Nhịp giảm kéo dài > 3 phút = Bất thường');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Nhịp giảm kéo dài ≤ 3 phút = Không an tâm');
                }
            }
            
            // Nhịp tăng
            if (formData.acceleration === 'present') {
                reassuring++;
                reasoningDetails.push('Có nhịp tăng = An tâm');
            } else if (formData.acceleration === 'absent') {
                nonReassuring++;
                reasoningDetails.push('Vắng mặt nhịp tăng = Không an tâm');
            }
            
            // Kết luận RCOG
            let classification, color;
            if (abnormal >= 1 || nonReassuring >= 2) {
                classification = 'BẤT THƯỜNG';
                color = 'abnormal';
                details.push('≥ 1 đặc điểm Bất thường hoặc ≥ 2 đặc điểm Không an tâm');
            } else if (nonReassuring === 1) {
                classification = 'NGHI NGỜ (Không an tâm)';
                color = 'suspicious';
                details.push('1 đặc điểm Không an tâm');
            } else if (reassuring === 4) {
                classification = 'BÌNH THƯỜNG (An tâm)';
                color = 'normal';
                details.push('4 đặc điểm đều An tâm');
            } else {
                classification = 'NGHI NGỜ (Không đủ thông tin)';
                color = 'suspicious';
                details.push('Không đủ thông tin để phân loại');
            }
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'RCOG 2001'
            };
        }
        
        function analyzeFIGO() {
            let normal = 0;
            let suspicious = 0;
            let pathological = 0;
            let details = [];
            let reasoningDetails = [];
            
            // Tim thai căn bản
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                normal++;
                reasoningDetails.push('Tim thai 110-160 bpm ổn định = Bình thường');
            } else if (baseline === '<80' || baseline === '80-100') {
                pathological++;
                reasoningDetails.push('Tim thai < 100 bpm = Bệnh lý');
            } else {
                suspicious++;
                reasoningDetails.push('Tim thai thiếu ít nhất một đặc điểm bình thường = Nghi ngờ');
            }
            
            // Dao động
            const variability = formData.variability;
            const hasReducedVariability = variability === 'minimal' || variability === 'undetectable';
            
            if (variability === 'moderate') {
                normal++;
                reasoningDetails.push('Dao động 5-25 bpm = Bình thường');
            } else if (variability === 'undetectable' || variability === 'marked' || variability === 'sinusoidal') {
                pathological++;
                if (variability === 'undetectable') {
                    reasoningDetails.push('Dao động giảm (không phát hiện được) = Bệnh lý');
                } else if (variability === 'marked') {
                    reasoningDetails.push('Dao động tăng (> 25 bpm) = Bệnh lý');
                } else {
                    reasoningDetails.push('Dao động dạng hình sin = Bệnh lý');
                }
            } else {
                suspicious++;
                reasoningDetails.push('Dao động thiếu ít nhất một đặc điểm bình thường = Nghi ngờ');
            }
            
            // Nhịp giảm
            const decelerations = formData.decelerations || [];
            if (decelerations.includes('none')) {
                normal++;
                reasoningDetails.push('Không có nhịp giảm lặp lại = Bình thường');
            } else if (decelerations.includes('late') && formData.late_repetitive === 'yes') {
                // Nhịp giảm muộn lặp lại
                if (formData.late_duration === '>30') {
                    pathological++;
                    reasoningDetails.push('Nhịp giảm muộn lặp lại > 30 phút = Bệnh lý');
                } else if (formData.late_duration === '20-30' && hasReducedVariability) {
                    pathological++;
                    reasoningDetails.push('Nhịp giảm muộn lặp lại 20-30 phút + giảm dao động nội tại = Bệnh lý');
                } else {
                    suspicious++;
                    reasoningDetails.push('Nhịp giảm muộn lặp lại < 30 phút = Nghi ngờ');
                }
            } else if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>2') {
                    pathological++;
                    reasoningDetails.push('Nhịp giảm kéo dài > 2 phút = Bệnh lý');
                } else if (formData.prolonged_occurrence_time === '>30') {
                    pathological++;
                    reasoningDetails.push('Nhịp giảm kéo dài lặp lại > 30 phút = Bệnh lý');
                } else if (formData.prolonged_occurrence_time === '20-30' && hasReducedVariability) {
                    pathological++;
                    reasoningDetails.push('Nhịp giảm kéo dài lặp lại 20-30 phút + giảm dao động nội tại = Bệnh lý');
                } else {
                    suspicious++;
                    reasoningDetails.push('Nhịp giảm kéo dài = Nghi ngờ');
                }
            } else if (decelerations.includes('variable') || decelerations.includes('early')) {
                suspicious++;
                reasoningDetails.push('Có nhịp giảm nhưng không đủ tiêu chí bệnh lý = Nghi ngờ');
            }
            
            // Kết luận
            let classification, color, management;
            if (pathological > 0) {
                classification = 'BỆNH LÝ';
                color = 'abnormal';
                management = 'Hành động ngay để khắc phục tình trạng thiếu oxy máu nếu điều này không thể chẩn đoán chậm trễ thai kỳ. Trong tình huống cấp cứu (sa dây rốn, vỡ tử cung, nhau bong non...), cần CDTK ngay lập tức';
                details.push('Thai nhi có khả năng cao bị thiếu oxy/toan máu');
            } else if (suspicious > 0) {
                classification = 'NGHI NGỜ';
                color = 'suspicious';
                management = 'Xác định và khắc phục nguyên nhân; theo dõi sát hoặc đánh giá thêm tình trạng oxy thai bằng các phương pháp khác';
                details.push('Thai nhi có nguy cơ (thấp) bị thiếu oxy/toan máu');
            } else {
                classification = 'BÌNH THƯỜNG';
                color = 'normal';
                management = 'Không cần can thiệp';
                details.push('Thai nhi không bị thiếu oxy/thoái toan');
            }
            
            details.push(`🔧 Xử trí: ${management}`);
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'FIGO 2015'
            };
        }
        
        function analyzeJapanese5() {
            // Logic phức tạp cho hệ thống 5 mức
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            
            let level = 1; // Mặc định level 1
            let reasoningDetails = [];
            
            // Logic cơ bản dựa trên bảng trong tài liệu
            if (baseline === '110-160' && variability === 'moderate' && decelerations.includes('none')) {
                level = 1;
                reasoningDetails.push('Tim thai 110-160 bpm + dao động trung bình + không có nhịp giảm = Mức 1');
            } else if ((baseline === '110-160' && variability === 'moderate' && decelerations.includes('early')) ||
                       (baseline === '>180' && variability === 'moderate' && decelerations.includes('none'))) {
                level = 2;
                reasoningDetails.push('Tim thai bình thường + dao động trung bình + nhịp giảm sớm = Mức 2');
            } else if (baseline === '<80' || variability === 'undetectable') {
                level = 4;
                reasoningDetails.push('Tim thai < 80 bpm hoặc dao động không phát hiện được = Mức 4');
            } else if (variability === 'sinusoidal') {
                level = 4;
                reasoningDetails.push('Dao động dạng hình sin = Mức 4');
            } else {
                level = 3; // Mặc định cho các trường hợp khác
                reasoningDetails.push('Các thông số khác không đạt mức 1-2 = Mức 3');
            }
            
            // Điều chỉnh dựa trên nhịp giảm nặng
            if (decelerations.includes('variable') && formData.variable_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nhịp giảm bất định nặng → Tăng lên ít nhất Mức 4');
            }
            
            if (decelerations.includes('late') && formData.late_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nhịp giảm muộn nặng (> 15 bpm từ baseline) → Tăng lên ít nhất Mức 4');
            }
            
            if (decelerations.includes('prolonged') && formData.prolonged_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nhịp giảm kéo dài nặng (điểm thấp nhất < 80 bpm) → Tăng lên ít nhất Mức 4');
            }
            
            // Level 5 cho các trường hợp rất nghiêm trọng
            if ((baseline === '<80' && variability === 'undetectable') ||
                (variability === 'undetectable' && decelerations.includes('variable') && formData.variable_severity === 'severe')) {
                level = 5;
                reasoningDetails.push('Tim thai < 80 bpm + không có dao động hoặc dao động không phát hiện được + nhịp giảm nặng = Mức 5');
            }
            
            let color, management;
            if (level === 1) {
                color = 'normal';
                management = 'Theo dõi bình thường';
            } else if (level === 2) {
                color = 'normal';
                management = 'Theo dõi bình thường, chú ý';
            } else if (level === 3) {
                color = 'suspicious';
                management = 'Theo dõi sát, cân nhắc can thiệp';
            } else if (level === 4) {
                color = 'abnormal';
                management = 'Cần can thiệp sớm';
            } else {
                color = 'abnormal';
                management = 'Cần can thiệp ngay lập tức';
            }
            
            reasoningDetails.push(`Khuyến nghị: ${management}`);
            
            return {
                classification: `MỨC ĐỘ ${level}`,
                color,
                details: reasoningDetails,
                system: 'Phân loại 5 mức (Nhật Bản)'
            };
        }
        
        function analyzePhysiological() {
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            let reasoningDetails = [];
            
            // Thiếu oxy cấp
            if (decelerations.includes('prolonged') && formData.prolonged_duration === '>3') {
                reasoningDetails.push('Nhịp giảm kéo dài > 3 phút → Nghi ngờ tai biến sản khoa');
                reasoningDetails.push('Cần loại trừ: sa dây rốn, nhau bong non, vỡ tử cung');
                return {
                    classification: 'THIẾU OXY CẤP',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            // Thiếu oxy bán cấp
            if (formData.time_comparison === 'deceleration_longer') {
                reasoningDetails.push('Thời gian trong nhịp giảm > thời gian ở baseline');
                reasoningDetails.push('Thời gian trong nhịp giảm > 90 giây, thời gian ở baseline < 30 giây');
                return {
                    classification: 'THIẾU OXY BÁN CẤP',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            // Đánh giá các yếu tố thiếu oxy diễn tiến
            const hasIncreasedBaseline = formData.baseline_increase_10 || formData.baseline_increase_20 || 
                                       formData.baseline_increase_10_normal || formData.baseline_increase_20_normal;
            const hasAbnormalVariability = variability === 'minimal' || variability === 'marked';
            const hasRecurrentDecelerations = (decelerations.includes('variable') && formData.variable_repetitive === 'yes') ||
                                             (decelerations.includes('late') && formData.late_repetitive === 'yes');
            const hasLostAcceleration = (formData.acceleration_disappear === 'yes' || formData.acceleration === 'absent');
            const hasBaselineLonger = formData.time_comparison === 'baseline_longer';
            
            // Thiếu oxy diễn tiến mất bù (đủ 3 tiêu chí)
            if (hasIncreasedBaseline && hasAbnormalVariability && hasRecurrentDecelerations) {
                reasoningDetails.push('✓ Tăng tim thai căn bản (tăng > 10% hoặc ≥ 20 bpm)');
                reasoningDetails.push('✓ Dao động nội tại bất thường (< 5 bpm hoặc > 25 bpm)');
                reasoningDetails.push('✓ Nhịp giảm lặp lại (bất định hoặc muộn)');
                reasoningDetails.push('Tim thai căn bản có thể giảm dần kiểu bậc thang → Nguy cơ cao');
                return {
                    classification: 'THIẾU OXY DIỄN TIẾN MẤT BÙ',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            // Thiếu oxy diễn tiến còn bù (đủ 4 tiêu chí)
            if (hasIncreasedBaseline && variability === 'moderate' && hasBaselineLonger && hasLostAcceleration) {
                reasoningDetails.push('✓ Tăng tim thai căn bản + dao động nội tại bình thường');
                reasoningDetails.push('✓ Thời gian ở baseline > thời gian trong nhịp giảm');
                reasoningDetails.push('✓ Mất nhịp tăng sau nhịp giảm');
                reasoningDetails.push('Cơ thể thai nhi vẫn đang bù trừ được → Theo dõi 30-60 phút');
                return {
                    classification: 'THIẾU OXY DIỄN TIẾN CÒN BÙ',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            // Gợi ý thiếu oxy diễn tiến mất bù (có 2/3 tiêu chí)
            let misbufferCount = 0;
            if (hasIncreasedBaseline) misbufferCount++;
            if (hasAbnormalVariability) misbufferCount++;
            if (hasRecurrentDecelerations) misbufferCount++;
            
            if (misbufferCount >= 2) {
                let presentCriteria = [];
                if (hasIncreasedBaseline) presentCriteria.push('Tăng tim thai căn bản');
                if (hasAbnormalVariability) presentCriteria.push('Dao động nội tại bất thường');
                if (hasRecurrentDecelerations) presentCriteria.push('Nhịp giảm lặp lại');
                
                reasoningDetails.push('Có 2/3 tiêu chí thiếu oxy diễn tiến mất bù:');
                reasoningDetails.push('✓ ' + presentCriteria.join(', ✓ '));
                reasoningDetails.push('→ Theo dõi sát, chuẩn bị can thiệp');
                return {
                    classification: 'GỢI Ý THIẾU OXY DIỄN TIẾN MẤT BÙ',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            // Gợi ý thiếu oxy diễn tiến còn bù (có 2-3/4 tiêu chí)
            let compensatedCount = 0;
            if (hasIncreasedBaseline) compensatedCount++;
            if (variability === 'moderate') compensatedCount++;
            if (hasBaselineLonger) compensatedCount++;
            if (hasLostAcceleration) compensatedCount++;
            
            if (compensatedCount >= 2) {
                let presentCriteria = [];
                if (hasIncreasedBaseline) presentCriteria.push('Tăng tim thai căn bản');
                if (variability === 'moderate') presentCriteria.push('Dao động nội tại bình thường');
                if (hasBaselineLonger) presentCriteria.push('Baseline dài hơn nhịp giảm');
                if (hasLostAcceleration) presentCriteria.push('Mất nhịp tăng');
                
                reasoningDetails.push(`Có ${compensatedCount}/4 tiêu chí thiếu oxy diễn tiến còn bù:`);
                reasoningDetails.push('✓ ' + presentCriteria.join(', ✓ '));
                reasoningDetails.push('→ Thai nhi đang cố gắng bù trừ, theo dõi 30-60 phút');
                return {
                    classification: 'GỢI Ý THIẾU OXY DIỄN TIẾN CÒN BÙ',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Phân loại Sinh lý'
                };
            }
            
            reasoningDetails.push('Không có đủ dấu hiệu của các pattern thiếu oxy đặc trưng');
            reasoningDetails.push('Thai nhi có thể đang trong tình trạng oxy hóa bình thường');
            return {
                classification: 'KHÔNG XÁC ĐỊNH THIẾU OXY',
                color: 'normal',
                details: reasoningDetails,
                system: 'Phân loại Sinh lý'
            };
        }
        
        function displayResults(results) {
            const container = document.getElementById('results_container');
            
            let html = '';
            
            Object.entries(results).forEach(([systemKey, result]) => {
                let colorClass = 'result-default'; // Default cho các hệ thống khác
                
                // NICE system
                if (result.system === 'NICE 2022') {
                    if (result.classification === 'BÌNH THƯỜNG') {
                        colorClass = 'result-nice-normal';
                    } else if (result.classification === 'NGHI NGỜ') {
                        colorClass = 'result-nice-suspicious';
                    } else if (result.classification === 'BẤT THƯỜNG') {
                        colorClass = 'result-nice-abnormal';
                    } else if (result.classification === 'KHÔNG PHÂN LOẠI ĐƯỢC') {
                        colorClass = 'result-nice-unclassified';
                    }
                }
                // Japanese 5-level system
                else if (result.system === 'Phân loại 5 mức (Nhật Bản)') {
                    if (result.classification === 'MỨC ĐỘ 1') {
                        colorClass = 'result-japanese-1';
                    } else if (result.classification === 'MỨC ĐỘ 2') {
                        colorClass = 'result-japanese-2';
                    } else if (result.classification === 'MỨC ĐỘ 3') {
                        colorClass = 'result-japanese-3';
                    } else if (result.classification === 'MỨC ĐỘ 4') {
                        colorClass = 'result-japanese-4';
                    } else if (result.classification === 'MỨC ĐỘ 5') {
                        colorClass = 'result-japanese-5';
                    }
                }
                
                html += `
                    <div class="result-card ${colorClass}">
                        <h4>${result.system}</h4>
                        <p><strong>${result.classification}</strong></p>
                        <ul>
                            ${result.details.map(detail => `<li>${detail}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function exportToPDF() {
            if (!analysisResults) {
                alert('Vui lòng phân tích kết quả trước khi xuất PDF');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Thiết lập font cho tiếng Việt (sử dụng font có sẵn)
            doc.setFont('helvetica', 'normal');
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            
            // Header
            doc.setFontSize(18);
            doc.text('BÁO CÁO PHÂN TÍCH CTG', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            doc.setFontSize(12);
            doc.text('Ngày: ' + new Date().toLocaleDateString('vi-VN'), pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 20;
            
            // Thêm ảnh CTG nếu có
            if (ctgImageData) {
                try {
                    doc.text('Ảnh CTG:', margin, yPosition);
                    yPosition += 10;
                    doc.addImage(ctgImageData, 'JPEG', margin, yPosition, 100, 60);
                    yPosition += 70;
                } catch (error) {
                    console.log('Không thể thêm ảnh vào PDF:', error);
                }
            }
            
            // Tóm tắt CTG
            doc.setFontSize(14);
            doc.text('1. TÓM TẮT THÔNG SỐ CTG', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            
            // Tạo summary text từ formData
            let summaryText = '';
            
            // Gò tử cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked')?.value;
            if (contraction === 'normal') summaryText += '• Gò tử cung: < 5 cơn/10 phút\n';
            else if (contraction === 'suspicious') summaryText += '• Gò tử cung: ≥ 5 cơn/10 phút\n';
            else if (contraction === 'prolonged') summaryText += '• Gò tử cung: Kéo dài ≥ 2 phút\n';
            
            // Tim thai căn bản
            const baseline = formData.baseline_fhr;
            if (baseline) {
                summaryText += `• Tim thai căn bản: ${baseline} bpm`;
                if (formData.baseline_stable === 'yes') summaryText += ' (ổn định)';
                else if (formData.baseline_100_109_type) summaryText += ` (${formData.baseline_100_109_type === 'new' ? 'mới xuất hiện' : 'đã có từ trước'})`;
                summaryText += '\n';
            }
            
            // Dao động nội tại
            const variability = formData.variability;
            if (variability) {
                let varText = '• Dao động nội tại: ';
                if (variability === 'moderate') varText += '6-25 bpm (bình thường)';
                else if (variability === 'minimal') varText += '3-5 bpm (giảm)';
                else if (variability === 'marked') varText += '>25 bpm (tăng)';
                else if (variability === 'undetectable') varText += 'Không phát hiện được';
                else if (variability === 'sinusoidal') varText += 'Dạng hình sin';
                summaryText += varText + '\n';
            }
            
            // Nhịp giảm
            const decelerations = formData.decelerations || [];
            if (decelerations.length > 0) {
                if (decelerations.includes('none')) {
                    summaryText += '• Nhịp giảm: Không có\n';
                } else {
                    let types = [];
                    if (decelerations.includes('early')) types.push('sớm');
                    if (decelerations.includes('variable')) types.push('bất định');
                    if (decelerations.includes('late')) types.push('muộn');
                    if (decelerations.includes('prolonged')) types.push('kéo dài');
                    summaryText += `• Nhịp giảm: ${types.join(', ')}\n`;
                }
            }
            
            // Nhịp tăng
            if (formData.acceleration) {
                summaryText += `• Nhịp tăng: ${formData.acceleration === 'present' ? 'Có' : 'Không có'}\n`;
            }
            
            const summaryLines = doc.splitTextToSize(summaryText, maxWidth);
            doc.text(summaryLines, margin, yPosition);
            yPosition += summaryLines.length * 5 + 10;
            
            // Kiểm tra trang mới
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Kết quả phân tích
            doc.setFontSize(14);
            doc.text('2. KẾT QUẢ PHÂN TÍCH', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            
            Object.values(analysisResults).forEach((result, index) => {
                // Kiểm tra nếu cần trang mới
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${result.system}:`, margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(11);
                doc.text(`Kết luận: ${result.classification}`, margin + 5, yPosition);
                yPosition += 8;
                
                doc.setFontSize(9);
                result.details.forEach(detail => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const cleanDetail = detail.replace(/[🟢🟡🔴⚠️📋🔧✓→]/g, '');
                    const lines = doc.splitTextToSize('- ' + cleanDetail, maxWidth - 10);
                    doc.text(lines, margin + 5, yPosition);
                    yPosition += lines.length * 4 + 2;
                });
                
                yPosition += 5;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Trang ${i}/${pageCount}`, pageWidth - margin, doc.internal.pageSize.height - 10, { align: 'right' });
                doc.text('Tạo bởi CTG Analyzer', margin, doc.internal.pageSize.height - 10);
            }
            
            // Lưu file
            const fileName = `CTG_Analysis_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
        }
        
        // Initialize radio button styling
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                // Remove selected class from all radio items with the same name
                document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(radio => {
                    radio.closest('.radio-item').classList.remove('selected');
                });
                // Add selected class to the checked radio item
                e.target.closest('.radio-item').classList.add('selected');
            } else if (e.target.type === 'checkbox') {
                // Toggle selected class for checkboxes
                if (e.target.checked) {
                    e.target.closest('.checkbox-item').classList.add('selected');
                } else {
                    e.target.closest('.checkbox-item').classList.remove('selected');
                }
            }
        });
    </script>
</body>
</html>
