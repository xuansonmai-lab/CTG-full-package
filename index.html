<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTG Analyzer - Ph√¢n t√≠ch CTG ƒëa chi·ªÅu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            min-height: 600px;
        }
        
        .form-section {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .results-section {
            flex: 1;
            padding: 30px;
            background: white;
            border-left: 3px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .form-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .sub-question {
            margin-left: 20px;
            margin-top: 15px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .radio-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .radio-item.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .checkbox-item.selected {
            background: #e8f4fd;
            border-color: #3498db;
        }
        
        .checkbox-item input[type="checkbox"]:disabled,
        .checkbox-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .results-header {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .result-card {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .result-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        /* NICE colors */
        .result-nice-normal {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #2c3e50;
            border: 2px solid #dee2e6;
        }
        
        .result-nice-suspicious {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .result-nice-abnormal {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .result-nice-unclassified {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #17a2b8;
        }
        
        /* Japanese 5-level colors */
        .result-japanese-1 {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .result-japanese-2 {
            background: linear-gradient(135deg, #cce7ff, #b3d9ff);
            color: #004085;
            border: 2px solid #007bff;
        }
        
        .result-japanese-3 {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .result-japanese-4 {
            background: linear-gradient(135deg, #ffe4cc, #ffd6b3);
            color: #8a2c0a;
            border: 2px solid #fd7e14;
        }
        
        .result-japanese-5 {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        /* Default colors for other systems */
        .result-default {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 2px solid #dee2e6;
        }
        
        .hidden {
            display: none;
        }
        
        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .export-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .export-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .reset-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .reset-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .image-upload {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 2px dashed #3498db;
            text-align: center;
        }
        
        .image-upload input[type="file"] {
            margin: 10px 0;
        }
        
        .image-display {
            position: sticky;
            top: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #3498db;
            z-index: 100;
        }
        
        .image-display h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
        }
        
        .image-display img {
            width: 100%;
            height: auto;
            max-height: 250px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-display img:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: scale(1.02);
        }
        
        .image-display .no-image {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        
        /* Modal for image zoom */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s;
        }
        
        .image-modal img {
            display: block;
            margin: auto;
            max-width: 95%;
            max-height: 95%;
            margin-top: 2.5%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(255,255,255,0.1);
        }
        
        .image-modal .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .image-modal .close:hover {
            color: #ccc;
        }
        
        .image-modal .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            text-align: center;
            font-size: 14px;
            opacity: 0.8;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 15px;
        }
        
        .summary-item {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #dee2e6;
        }
        
        .summary-item.selected {
            border-left-color: #3498db;
            background: #e8f4fd;
        }
        
        .summary-item strong {
            color: #2c3e50;
        }
        
        .summary-detail {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 4px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .image-display {
                position: relative;
                top: auto;
                margin-bottom: 15px;
            }
            
            .image-display img {
                max-height: 180px;
            }
            
            .image-modal img {
                max-width: 98%;
                max-height: 90%;
                margin-top: 5%;
            }
            
            .image-modal .close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CTG Analyzer</h1>
            <p>Ph√¢n t√≠ch CTG ƒëa chi·ªÅu theo c√°c hi·ªáp h·ªôi qu·ªëc t·∫ø</p>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <!-- Upload ·∫£nh CTG -->
                <div class="image-upload">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">üìÅ T·∫£i l√™n ·∫£nh CTG</h3>
                    <p style="color: #6c757d; margin-bottom: 10px;">Ch·ªçn file ·∫£nh CTG ƒë·ªÉ tham kh·∫£o khi ph√¢n t√≠ch</p>
                    <input type="file" id="ctgImage" accept="image/*" onchange="handleImageUpload(event)">
                </div>
                
                <!-- ID B·ªánh nh√¢n -->
                <div class="form-group">
                    <h3>üè• ID B·ªánh nh√¢n (t√πy ch·ªçn)</h3>
                    <div style="margin-top: 10px;">
                        <input type="text" id="patientId" placeholder="Nh·∫≠p ID b·ªánh nh√¢n (n·∫øu c√≥)" 
                               style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: border-color 0.3s;"
                               onchange="updateProgress(); forceUpdateSummary();"
                               onfocus="this.style.borderColor='#3498db'"
                               onblur="this.style.borderColor='#e9ecef'">
                    </div>
                </div>
                
                <!-- Hi·ªÉn th·ªã ·∫£nh CTG c·ªë ƒë·ªãnh -->
                <div class="image-display" id="imageDisplay">
                    <h4>üñºÔ∏è ·∫¢nh CTG tham kh·∫£o (Click ƒë·ªÉ ph√≥ng to)</h4>
                    <div id="stickyImageContainer">
                        <div class="no-image">Ch∆∞a c√≥ ·∫£nh CTG. T·∫£i l√™n ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã t·∫°i ƒë√¢y.</div>
                    </div>
                </div>
                
                <!-- Modal for image zoom -->
                <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                    <span class="close" onclick="closeImageModal()">&times;</span>
                    <img id="modalImage" src="" alt="CTG Zoomed">
                    <div class="instructions">Click anywhere or press ESC to close</div>
                </div>
                
                <!-- G√≤ t·ª≠ cung -->
                <div class="form-group">
                    <h3>1. G√≤ t·ª≠ cung</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="normal" onchange="updateProgress(); forceUpdateSummary();">
                            < 5 c∆°n/10 ph√∫t
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="suspicious" onchange="updateProgress(); forceUpdateSummary();">
                            ‚â• 5 c∆°n/10 ph√∫t
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="uterine_contraction" value="prolonged" onchange="updateProgress(); forceUpdateSummary();">
                            C∆°n co k√©o d√†i ‚â• 2 ph√∫t
                        </label>
                    </div>
                </div>

                <!-- Tim thai cƒÉn b·∫£n -->
                <div class="form-group">
                    <h3>2. Tim thai cƒÉn b·∫£n</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="<80" onchange="handleBaselineFHR(this)">
                            < 80 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="80-100" onchange="handleBaselineFHR(this)">
                            80-100 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="100-109" onchange="handleBaselineFHR(this)">
                            100-109 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="110-160" onchange="handleBaselineFHR(this)">
                            110-160 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="160-179" onchange="handleBaselineFHR(this)">
                            160-179 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value=">180" onchange="handleBaselineFHR(this)">
                            > 180 bpm
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_fhr" value="unidentifiable" onchange="handleBaselineFHR(this)">
                            Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c baseline
                        </label>
                    </div>
                    
                    <div id="baseline_sub_questions" class="hidden">
                        <!-- Sub questions s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <!-- Dao ƒë·ªông n·ªôi t·∫°i -->
                <div class="form-group">
                    <h3>3. Dao ƒë·ªông n·ªôi t·∫°i (Variability)</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="variability" value="undetectable" onchange="handleVariability(this)">
                            Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c (< 3 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="minimal" onchange="handleVariability(this)">
                            T·ªëi thi·ªÉu (3-5 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="moderate" onchange="handleVariability(this)">
                            Trung b√¨nh (6-25 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="marked" onchange="handleVariability(this)">
                            TƒÉng (> 25 bpm)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variability" value="sinusoidal" onchange="handleVariability(this)">
                            D·∫°ng h√¨nh sin
                        </label>
                    </div>
                    
                    <div id="variability_sub_questions" class="hidden">
                        <!-- Sub questions s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <!-- Nh·ªãp gi·∫£m -->
                <div class="form-group">
                    <h3>4. Nh·ªãp gi·∫£m (Decelerations)</h3>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="none" onchange="handleDeceleration(this)">
                            Kh√¥ng c√≥ nh·ªãp gi·∫£m
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="early" onchange="handleDeceleration(this)">
                            Nh·ªãp gi·∫£m s·ªõm
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="variable" onchange="handleDeceleration(this)">
                            Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh (bi·∫øn ƒë·ªïi)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="late" onchange="handleDeceleration(this)">
                            Nh·ªãp gi·∫£m mu·ªôn
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="deceleration" value="prolonged" onchange="handleDeceleration(this)">
                            Nh·ªãp gi·∫£m k√©o d√†i
                        </label>
                    </div>
                    
                    <div id="deceleration_sub_questions" class="hidden">
                        <!-- Sub questions s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <!-- Nh·ªãp tƒÉng -->
                <div class="form-group">
                    <h3>5. Nh·ªãp tƒÉng (Accelerations)</h3>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="acceleration" value="present" onchange="handleAcceleration(this)">
                            C√≥ nh·ªãp tƒÉng
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="acceleration" value="absent" onchange="handleAcceleration(this)">
                            Kh√¥ng c√≥ nh·ªãp tƒÉng
                        </label>
                    </div>
                    
                    <div id="acceleration_sub_questions" class="hidden">
                        <!-- Sub questions s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <div id="ctg_summary" class="form-group" style="display: none;">
                    <h3>üìã T·ªïng quan CTG</h3>
                    <div id="summary_content" class="summary-section">
                        <!-- Summary s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>

                <button class="analyze-btn" onclick="analyzeResults()">üîç Ph√¢n t√≠ch k·∫øt qu·∫£</button>
                <button class="export-btn" id="exportBtn" onclick="exportToPDF()" disabled>üìÑ Xu·∫•t b√°o c√°o PDF</button>
                <button class="save-btn" id="saveBtn" onclick="saveDataToServer()" disabled>üíæ L∆∞u d·ªØ li·ªáu</button>
                <button class="reset-btn" id="resetBtn" onclick="resetForm()" disabled>üîÑ ƒê√°nh gi√° ti·∫øp</button>
                
                <div id="statusMessage" class="status-message"></div>
            </div>
            
            <div class="results-section">
                <h2 class="results-header">K·∫øt qu·∫£ ph√¢n t√≠ch</h2>
                <div id="results_container">
                    <p style="text-align: center; color: #7f8c8d; font-style: italic;">
                        Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ xem k·∫øt qu·∫£ ph√¢n t√≠ch
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let formData = {};
        let ctgImageData = null;
        let analysisResults = null;
        
        // Google Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMWjr1vQIKb4-uPLYXBmzOtl3WLgrzyOc47nRDrkX2l_-573-7CEGcMJaafxHQkFUm/exec';
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    ctgImageData = e.target.result;
                    const container = document.getElementById('stickyImageContainer');
                    container.innerHTML = `<img src="${e.target.result}" alt="CTG Image" onclick="openImageModal('${e.target.result}')">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        });
        
        function updateProgress() {
            const totalQuestions = 5;
            let completed = 0;
            
            if (document.querySelector('input[name="uterine_contraction"]:checked')) completed++;
            if (document.querySelector('input[name="baseline_fhr"]:checked')) completed++;
            if (document.querySelector('input[name="variability"]:checked')) completed++;
            if (document.querySelector('input[name="deceleration"]:checked')) completed++;
            if (document.querySelector('input[name="acceleration"]:checked')) completed++;
            
            const percentage = (completed / totalQuestions) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            
            // Hi·ªÉn th·ªã t·ªïng qu√°t CTG ngay khi c√≥ √≠t nh·∫•t 1 th√¥ng tin
            if (completed >= 1) {
                updateCTGSummary();
            }
        }
        
        // H√†m ƒë·ªÉ force update summary
        function forceUpdateSummary() {
            setTimeout(updateCTGSummary, 100);
        }
        
        function updateCTGSummary() {
            const summaryContainer = document.getElementById('ctg_summary');
            const summaryContent = document.getElementById('summary_content');
            
            let summaryItems = [];
            
            // ID B·ªánh nh√¢n (n·∫øu c√≥)
            const patientId = document.getElementById('patientId').value.trim();
            if (patientId) {
                summaryItems.push(`<div class="summary-item selected"><strong>üè• ID B·ªánh nh√¢n:</strong> ${patientId}</div>`);
            }
            
            // G√≤ t·ª≠ cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                let status = '';
                let detail = '';
                if (contraction.value === 'normal') {
                    status = 'üü¢ B√¨nh th∆∞·ªùng';
                    detail = 'T·∫ßn su·∫•t co b√≥p < 5 c∆°n/10 ph√∫t';
                } else if (contraction.value === 'suspicious') {
                    status = 'üü° TƒÉng';
                    detail = 'T·∫ßn su·∫•t co b√≥p ‚â• 5 c∆°n/10 ph√∫t - c·∫ßn theo d√µi';
                } else if (contraction.value === 'prolonged') {
                    status = 'üü° K√©o d√†i';
                    detail = 'C∆°n co k√©o d√†i ‚â• 2 ph√∫t - c√≥ th·ªÉ ·∫£nh h∆∞·ªüng l∆∞u l∆∞·ª£ng m√°u';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>G√≤ t·ª≠ cung:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Tim thai cƒÉn b·∫£n - chi ti·∫øt h∆°n
            const baseline = formData.baseline_fhr;
            if (baseline) {
                let status = '';
                let detail = '';
                if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                    status = 'üü¢ B√¨nh th∆∞·ªùng (110-160 bpm)';
                    detail = 'Tim thai ·ªïn ƒë·ªãnh v√† ph√π h·ª£p tu·ªïi thai';
                } else if (baseline === '100-109') {
                    const type = formData.baseline_100_109_type === 'new' ? 'm·ªõi xu·∫•t hi·ªán' : 'ƒë√£ c√≥ t·ª´ tr∆∞·ªõc';
                    status = `üü° Ch·∫≠m nh·∫π (100-109 bpm)`;
                    detail = `Tim thai ch·∫≠m ${type} - c·∫ßn theo d√µi s√°t`;
                } else if (baseline === '160-179') {
                    status = 'üî¥ TƒÉng nh·∫π (160-179 bpm)';
                    detail = 'Tim thai tƒÉng - c√≥ th·ªÉ do thi·∫øu oxy, nhi·ªÖm tr√πng ho·∫∑c thu·ªëc';
                    if (formData.baseline_increase_20) {
                        detail += ' ‚Ä¢ TƒÉng ‚â•20 bpm so v·ªõi tr∆∞·ªõc';
                    }
                } else if (baseline === '>180') {
                    status = 'üî¥ TƒÉng n·∫∑ng (>180 bpm)';
                    detail = 'Tim thai tƒÉng nghi√™m tr·ªçng - c·∫ßn can thi·ªáp ngay';
                } else if (baseline === '<80' || baseline === '80-100') {
                    status = 'üî¥ Ch·∫≠m n·∫∑ng (<100 bpm)';
                    detail = 'Tim thai ch·∫≠m nghi√™m tr·ªçng - nguy c∆° thi·∫øu oxy thai nhi';
                } else if (baseline === 'unidentifiable') {
                    status = 'üü° Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c';
                    detail = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh tim thai cƒÉn b·∫£n - c·∫ßn c·∫£i thi·ªán t√≠n hi·ªáu';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Tim thai cƒÉn b·∫£n:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Dao ƒë·ªông n·ªôi t·∫°i - chi ti·∫øt h∆°n
            const variability = formData.variability;
            if (variability) {
                let status = '';
                let detail = '';
                if (variability === 'moderate') {
                    status = 'üü¢ B√¨nh th∆∞·ªùng (6-25 bpm)';
                    detail = 'Dao ƒë·ªông n·ªôi t·∫°i t·ªët - h·ªá th·∫ßn kinh thai nhi ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng';
                } else if (variability === 'minimal') {
                    status = 'üü°/üî¥ Gi·∫£m (3-5 bpm)';
                    if (formData.minimal_duration === '30-50') {
                        detail = 'Dao ƒë·ªông gi·∫£m trong 30-50 ph√∫t - theo d√µi s√°t';
                    } else if (formData.minimal_duration === '>50') {
                        detail = 'Dao ƒë·ªông gi·∫£m >50 ph√∫t - nguy c∆° thi·∫øu oxy thai nhi';
                    } else {
                        detail = 'Dao ƒë·ªông n·ªôi t·∫°i gi·∫£m - c·∫ßn ƒë√°nh gi√° th·ªùi gian';
                    }
                } else if (variability === 'marked') {
                    status = 'üü°/üî¥ TƒÉng (>25 bpm)';
                    if (formData.marked_duration === '‚â§10') {
                        detail = 'Dao ƒë·ªông tƒÉng ‚â§10 ph√∫t - c√≥ th·ªÉ do ho·∫°t ƒë·ªông thai nhi';
                    } else if (formData.marked_duration === '>10') {
                        detail = 'Dao ƒë·ªông tƒÉng >10 ph√∫t - c·∫ßn theo d√µi s√°t';
                    } else {
                        detail = 'Dao ƒë·ªông n·ªôi t·∫°i tƒÉng - c·∫ßn ƒë√°nh gi√° th·ªùi gian';
                    }
                } else if (variability === 'undetectable') {
                    status = 'üî¥ Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c';
                    detail = 'M·∫•t ho√†n to√†n dao ƒë·ªông n·ªôi t·∫°i - nguy c∆° cao thi·∫øu oxy thai nhi';
                } else if (variability === 'sinusoidal') {
                    status = 'üî¥ D·∫°ng h√¨nh sin';
                    detail = 'Bi·ªÉu ƒë·ªì d·∫°ng h√¨nh sin - nguy c∆° r·∫•t cao, c·∫ßn can thi·ªáp ngay';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Dao ƒë·ªông n·ªôi t·∫°i:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Nh·ªãp gi·∫£m - chi ti·∫øt h∆°n
            const decelerations = formData.decelerations || [];
            if (decelerations.length > 0) {
                if (decelerations.includes('none')) {
                    summaryItems.push(`<div class="summary-item selected"><strong>Nh·ªãp gi·∫£m:</strong> üü¢ Kh√¥ng c√≥<div class="summary-detail">Kh√¥ng c√≥ nh·ªãp gi·∫£m b·∫•t th∆∞·ªùng</div></div>`);
                } else {
                    let types = [];
                    let details = [];
                    
                    if (decelerations.includes('early')) {
                        types.push('S·ªõm');
                        details.push('Nh·ªãp gi·∫£m s·ªõm - th∆∞·ªùng l√†nh t√≠nh');
                    }
                    if (decelerations.includes('variable')) {
                        types.push('B·∫•t ƒë·ªãnh');
                        if (formData.variable_severity === 'severe') {
                            details.push('Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh n·∫∑ng - nguy c∆° thi·∫øu oxy');
                        } else {
                            details.push('Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh nh·∫π');
                        }
                        if (formData.variable_repetitive === 'yes') {
                            details.push('‚Ä¢ L·∫∑p l·∫°i');
                            if (formData.worrying_features && formData.worrying_features.length > 0) {
                                details.push('‚Ä¢ C√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i');
                            }
                        }
                    }
                    if (decelerations.includes('late')) {
                        types.push('Mu·ªôn');
                        if (formData.late_severity === 'severe') {
                            details.push('Nh·ªãp gi·∫£m mu·ªôn n·∫∑ng - thi·∫øu oxy thai nhi');
                        } else {
                            details.push('Nh·ªãp gi·∫£m mu·ªôn - nguy c∆° thi·∫øu oxy');
                        }
                        if (formData.late_repetitive === 'yes') {
                            details.push('‚Ä¢ L·∫∑p l·∫°i');
                        }
                    }
                    if (decelerations.includes('prolonged')) {
                        types.push('K√©o d√†i');
                        if (formData.prolonged_duration === '>3') {
                            details.push('K√©o d√†i >3 ph√∫t - tim thai ch·∫≠m c·∫•p');
                        } else {
                            details.push('Nh·ªãp gi·∫£m k√©o d√†i');
                        }
                    }
                    
                    summaryItems.push(`<div class="summary-item selected"><strong>Nh·ªãp gi·∫£m:</strong> üü°/üî¥ ${types.join(', ')}<div class="summary-detail">${details.join(' ')}</div></div>`);
                }
            }
            
            // Nh·ªãp tƒÉng
            if (formData.acceleration) {
                let status = '';
                let detail = '';
                if (formData.acceleration === 'present') {
                    status = 'üü¢ C√≥';
                    detail = 'C√≥ nh·ªãp tƒÉng - d·∫•u hi·ªáu t·ªët c·ªßa thai nhi kh·ªèe m·∫°nh';
                    if (formData.acceleration_disappear === 'yes') {
                        detail += ' ‚Ä¢ Bi·∫øn m·∫•t sau nh·ªãp gi·∫£m - c√≥ th·ªÉ do thi·∫øu oxy';
                    }
                } else {
                    status = 'üü° Kh√¥ng c√≥';
                    detail = 'V·∫Øng m·∫∑t nh·ªãp tƒÉng - c·∫ßn theo d√µi s√°t';
                }
                summaryItems.push(`<div class="summary-item selected"><strong>Nh·ªãp tƒÉng:</strong> ${status}<div class="summary-detail">${detail}</div></div>`);
            }
            
            // Th√™m th√¥ng tin so s√°nh th·ªùi gian
            if (formData.time_comparison) {
                let detail = '';
                if (formData.time_comparison === 'baseline_longer') {
                    detail = 'Th·ªùi gian ·ªü tim thai cƒÉn b·∫£n d√†i h∆°n th·ªùi gian trong nh·ªãp gi·∫£m - t√¨nh tr·∫°ng t∆∞∆°ng ƒë·ªëi ·ªïn ƒë·ªãnh';
                } else {
                    detail = 'Th·ªùi gian trong nh·ªãp gi·∫£m d√†i h∆°n th·ªùi gian ·ªü baseline - nguy c∆° thi·∫øu oxy';
                }
                summaryItems.push(`<div class="summary-item"><strong>So s√°nh th·ªùi gian:</strong><div class="summary-detail">${detail}</div></div>`);
            }
            
            summaryContent.innerHTML = summaryItems.join('');
            summaryContainer.style.display = 'block';
        }
        
        function handleBaselineFHR(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('baseline_sub_questions');
            
            formData.baseline_fhr = value;
            
            let subHTML = '';
            
            if (value === '100-109') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai 100-109 bpm n√†y:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="baseline_100_109_type" value="new" onchange="formData.baseline_100_109_type = this.value; updateProgress(); forceUpdateSummary(); showStepDownQuestion();">
                                M·ªõi xu·∫•t hi·ªán (tr∆∞·ªõc ƒë√≥ > 109 bpm)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="baseline_100_109_type" value="existing" onchange="formData.baseline_100_109_type = this.value; updateProgress(); forceUpdateSummary(); hideStepDownQuestion();">
                                ƒê√£ c√≥ t·ª´ tr∆∞·ªõc (bƒÉng ghi tr∆∞·ªõc c≈©ng 100-109 bpm)
                            </label>
                        </div>
                        <div id="step_down_sub" class="hidden">
                            <!-- Step down question s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                `;
            } else if (value === '110-160') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai c√≥ ·ªïn ƒë·ªãnh v√† ph√π h·ª£p tu·ªïi thai kh√¥ng?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="baseline_stable" value="yes" onchange="formData.baseline_stable = this.value; updateProgress(); forceUpdateSummary();">
                                C√≥ - ·ªïn ƒë·ªãnh v√† ph√π h·ª£p
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="baseline_stable" value="no" onchange="handleBaselineUnstable(this)">
                                Kh√¥ng - c√≥ thay ƒë·ªïi
                            </label>
                        </div>
                        <div id="baseline_unstable_sub" class="hidden">
                            <!-- Sub questions cho tr∆∞·ªùng h·ª£p kh√¥ng ·ªïn ƒë·ªãnh -->
                        </div>
                    </div>
                `;
            } else if (value === '<80' || value === '80-100') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Tim thai ch·∫≠m n√†y c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="bradycardia_step_down" value="yes" onchange="formData.bradycardia_step_down = this.value; updateProgress(); forceUpdateSummary();">
                                C√≥ step down (gi·∫£m d·∫ßn so v·ªõi bƒÉng ghi tr∆∞·ªõc)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="bradycardia_step_down" value="no" onchange="formData.bradycardia_step_down = this.value; updateProgress(); forceUpdateSummary();">
                                Kh√¥ng c√≥ step down
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (value === '160-179' || value === '>180') {
                subHTML += `
                    <div class="sub-question">
                        <h4>TƒÉng tim thai n√†y:</h4>
                        <p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Tim thai > 160 bpm = T·ª± ƒë·ªông coi l√† tƒÉng tim thai cƒÉn b·∫£n</p>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="baseline_increase_10" value="yes" onchange="formData.baseline_increase_10 = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();" checked disabled>
                                TƒÉng > 10% so v·ªõi bƒÉng ghi tr∆∞·ªõc ƒë√≥ (T·ª± ƒë·ªông)
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="baseline_increase_20" value="yes" onchange="formData.baseline_increase_20 = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                                TƒÉng ‚â• 20 bpm so v·ªõi bƒÉng ghi tr∆∞·ªõc ƒë√≥
                            </label>
                        </div>
                        <div id="sleep_cycle_sub" class="hidden">
                            <!-- Sleep cycle question s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                `;
                // T·ª± ƒë·ªông set gi√° tr·ªã
                formData.baseline_increase_10 = true;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function showStepDownQuestion() {
            const subContainer = document.getElementById('step_down_sub');
            const subHTML = `
                <div class="sub-question">
                    <h4>Tim thai 100-109 m·ªõi xu·∫•t hi·ªán n√†y:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="baseline_step_down" value="yes" onchange="formData.baseline_step_down = this.value; updateProgress(); forceUpdateSummary();">
                            C√≥ step down (gi·∫£m so v·ªõi bƒÉng ghi tr∆∞·ªõc)
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="baseline_step_down" value="no" onchange="formData.baseline_step_down = this.value; updateProgress(); forceUpdateSummary();">
                            Kh√¥ng c√≥ step down
                        </label>
                    </div>
                </div>
            `;
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
        }
        
        function hideStepDownQuestion() {
            const subContainer = document.getElementById('step_down_sub');
            subContainer.classList.add('hidden');
            formData.baseline_step_down = null;
        }
        
        function toggleSleepCycleQuestion() {
            const hasIncrease = formData.baseline_increase_10 || formData.baseline_increase_20 || 
                              formData.baseline_increase_10_normal || formData.baseline_increase_20_normal;
            
            const subContainer = document.getElementById('sleep_cycle_sub');
            
            if (hasIncrease) {
                const subHTML = `
                    <div class="sub-question">
                        <h4>Thai nhi c√≤n chu k·ª≥ t·ªânh ng·ªß kh√¥ng?</h4>
                        <p style="color: #6c757d; font-size: 0.9em;">M√¥ t·∫£: m·∫•t nh·ªãp tƒÉng v√† c√≥ nh·ªãp tƒÉng xen k·∫Ω t∆∞∆°ng ·ª©ng v·ªõi chu k·ª≥ ng·ªß v√† t·ªânh</p>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="sleep_cycle" value="yes" onchange="formData.sleep_cycle = this.value; updateProgress(); forceUpdateSummary();">
                                C√≥ - v·∫´n c√≤n chu k·ª≥ t·ªânh ng·ªß
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="sleep_cycle" value="no" onchange="formData.sleep_cycle = this.value; updateProgress(); forceUpdateSummary();">
                                Kh√¥ng - m·∫•t chu k·ª≥ t·ªânh ng·ªß
                            </label>
                        </div>
                    </div>
                `;
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
                formData.sleep_cycle = null;
            }
        }
        
        function handleBaselineUnstable(element) {
            const subContainer = document.getElementById('baseline_unstable_sub');
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Lo·∫°i thay ƒë·ªïi:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="baseline_increase_10_normal" value="yes" onchange="formData.baseline_increase_10_normal = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                            TƒÉng > 10% so v·ªõi bƒÉng ghi tr∆∞·ªõc ƒë√≥
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="baseline_increase_20_normal" value="yes" onchange="formData.baseline_increase_20_normal = this.checked; updateProgress(); forceUpdateSummary(); toggleSleepCycleQuestion();">
                            TƒÉng ‚â• 20 bpm so v·ªõi bƒÉng ghi tr∆∞·ªõc ƒë√≥
                        </label>
                    </div>
                    <div id="sleep_cycle_sub" class="hidden">
                        <!-- Sleep cycle question s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariability(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('variability_sub_questions');
            
            formData.variability = value;
            
            let subHTML = '';
            
            if (value === 'minimal') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Th·ªùi gian dao ƒë·ªông < 5 bpm:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="minimal_duration" value="30-50" onchange="formData.minimal_duration = this.value; updateProgress(); forceUpdateSummary();">
                                30-50 ph√∫t
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="minimal_duration" value=">50" onchange="formData.minimal_duration = this.value; updateProgress(); forceUpdateSummary();">
                                > 50 ph√∫t
                            </label>
                        </div>
                    </div>
                `;
            } else if (value === 'marked') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Th·ªùi gian dao ƒë·ªông > 25 bpm:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="marked_duration" value="‚â§10" onchange="formData.marked_duration = this.value; updateProgress(); forceUpdateSummary();">
                                ‚â§ 10 ph√∫t
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="marked_duration" value=">10" onchange="formData.marked_duration = this.value; updateProgress(); forceUpdateSummary();">
                                > 10 ph√∫t
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function handleDeceleration(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('deceleration_sub_questions');
            
            // Handle checkbox logic
            if (element.checked) {
                if (value === 'none') {
                    // Uncheck all other decelerations if "none" is selected
                    document.querySelectorAll('input[name="deceleration"]:not([value="none"])').forEach(cb => {
                        cb.checked = false;
                    });
                } else {
                    // Uncheck "none" if any other deceleration is selected
                    document.querySelector('input[name="deceleration"][value="none"]').checked = false;
                }
            }
            
            // Collect all checked decelerations
            const checkedDecelerations = Array.from(document.querySelectorAll('input[name="deceleration"]:checked'))
                .map(cb => cb.value);
            
            formData.decelerations = checkedDecelerations;
            
            let subHTML = '';
            
            if (checkedDecelerations.includes('variable')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_severity" value="mild" onchange="handleVariableDeceleration(this)">
                                Nh·∫π
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_severity" value="severe" onchange="handleVariableDeceleration(this)">
                                N·∫∑ng (ƒëi·ªÉm th·∫•p nh·∫•t < 70 bpm v√† > 30s ho·∫∑c 70-80 bpm v√† > 60s)
                            </label>
                        </div>
                        <div id="variable_sub" class="hidden"></div>
                    </div>
                `;
            }
            
            if (checkedDecelerations.includes('late')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nh·ªãp gi·∫£m mu·ªôn:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="late_severity" value="mild" onchange="formData.late_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nh·∫π
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="late_severity" value="severe" onchange="formData.late_severity = this.value; updateProgress(); forceUpdateSummary();">
                                N·∫∑ng (> 15 bpm t·ª´ baseline)
                            </label>
                        </div>
                        <div class="sub-question">
                            <h4>T√≠nh ch·∫•t:</h4>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="late_repetitive" value="yes" onchange="handleLateRepetitive(this)">
                                    L·∫∑p l·∫°i
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="late_repetitive" value="no" onchange="formData.late_repetitive = this.value; updateProgress(); forceUpdateSummary();">
                                    Kh√¥ng l·∫∑p l·∫°i
                                </label>
                            </div>
                            <div id="late_repetitive_sub" class="hidden"></div>
                        </div>
                    </div>
                `;
            }
            
            if (checkedDecelerations.includes('prolonged')) {
                subHTML += `
                    <div class="sub-question">
                        <h4>Nh·ªãp gi·∫£m k√©o d√†i:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="prolonged_severity" value="mild" onchange="formData.prolonged_severity = this.value; updateProgress(); forceUpdateSummary();">
                                Nh·∫π
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="prolonged_severity" value="severe" onchange="formData.prolonged_severity = this.value; updateProgress(); forceUpdateSummary();">
                                N·∫∑ng (ƒëi·ªÉm th·∫•p nh·∫•t < 80 bpm)
                            </label>
                        </div>
                        <div class="sub-question">
                            <h4>Th·ªùi gian:</h4>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value="<2" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    < 2 ph√∫t
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value="2-3" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    2-3 ph√∫t
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="prolonged_duration" value=">3" onchange="formData.prolonged_duration = this.value; updateProgress(); forceUpdateSummary();">
                                    > 3 ph√∫t
                                </label>
                            </div>
                            <div class="sub-question">
                                <h4>Th·ªùi gian xu·∫•t hi·ªán (cho FIGO):</h4>
                                <div class="radio-group">
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value="<20" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        < 20 ph√∫t
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value="20-30" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        20-30 ph√∫t
                                    </label>
                                    <label class="radio-item">
                                        <input type="radio" name="prolonged_occurrence_time" value=">30" onchange="formData.prolonged_occurrence_time = this.value; updateProgress(); forceUpdateSummary();">
                                        > 30 ph√∫t
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Th√™m c√¢u h·ªèi v·ªÅ th·ªùi gian trong nh·ªãp gi·∫£m vs baseline
            if (checkedDecelerations.some(d => ['variable', 'late', 'prolonged'].includes(d))) {
                subHTML += `
                    <div class="sub-question">
                        <h4>So s√°nh th·ªùi gian:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="time_comparison" value="baseline_longer" onchange="formData.time_comparison = this.value; updateProgress(); forceUpdateSummary();">
                                Th·ªùi gian ·ªü tim thai cƒÉn b·∫£n d√†i h∆°n
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="time_comparison" value="deceleration_longer" onchange="formData.time_comparison = this.value; updateProgress(); forceUpdateSummary();">
                                Th·ªùi gian trong nh·ªãp gi·∫£m d√†i h∆°n
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function handleVariableDeceleration(element) {
            const value = element.value;
            const subContainer = document.getElementById('variable_sub');
            
            formData.variable_severity = value;
            
            const subHTML = `
                <div class="sub-question">
                    <h4>T√≠nh ch·∫•t:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="variable_repetitive" value="yes" onchange="handleVariableRepetitive(this)">
                            L·∫∑p l·∫°i
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="variable_repetitive" value="no" onchange="handleVariableNonRepetitive(this)">
                            Kh√¥ng l·∫∑p l·∫°i
                        </label>
                    </div>
                    <div id="variable_repetitive_sub" class="hidden"></div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariableRepetitive(element) {
            const subContainer = document.getElementById('variable_repetitive_sub');
            formData.variable_repetitive = 'yes';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>ƒê·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="duration_>60s" onchange="updateWorryingFeatures()">
                            K√©o d√†i > 60 gi√¢y
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="reduced_variability" onchange="updateWorryingFeatures()">
                            Gi·∫£m dao ƒë·ªông trong nh·ªãp gi·∫£m
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="slow_return" onchange="updateWorryingFeatures()">
                            Tr·ªü v·ªÅ baseline ch·∫≠m ho·∫∑c kh√¥ng tr·ªü v·ªÅ
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features" value="no_shouldering" onchange="updateWorryingFeatures()">
                            M·∫•t d·∫°ng vai (shouldering)
                        </label>
                    </div>
                    <div class="sub-question">
                        <h4>Th·ªùi gian xu·∫•t hi·ªán:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_duration" value="<30" onchange="formData.variable_duration = this.value; forceUpdateSummary();">
                                < 30 ph√∫t
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_duration" value="‚â•30" onchange="formData.variable_duration = this.value; forceUpdateSummary();">
                                ‚â• 30 ph√∫t
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleVariableNonRepetitive(element) {
            const subContainer = document.getElementById('variable_repetitive_sub');
            formData.variable_repetitive = 'no';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>ƒê·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i:</h4>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="duration_>60s" onchange="updateWorryingFeaturesNonRep()">
                            K√©o d√†i > 60 gi√¢y
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="reduced_variability" onchange="updateWorryingFeaturesNonRep()">
                            Gi·∫£m dao ƒë·ªông trong nh·ªãp gi·∫£m
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="slow_return" onchange="updateWorryingFeaturesNonRep()">
                            Tr·ªü v·ªÅ baseline ch·∫≠m ho·∫∑c kh√¥ng tr·ªü v·ªÅ
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="worrying_features_nonrep" value="no_shouldering" onchange="updateWorryingFeaturesNonRep()">
                            M·∫•t d·∫°ng vai (shouldering)
                        </label>
                    </div>
                    <div class="sub-question">
                        <h4>Th·ªùi gian xu·∫•t hi·ªán:</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="variable_nonrep_duration" value="<30" onchange="formData.variable_nonrep_duration = this.value; forceUpdateSummary();">
                                < 30 ph√∫t
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="variable_nonrep_duration" value="‚â•30" onchange="formData.variable_nonrep_duration = this.value; forceUpdateSummary();">
                                ‚â• 30 ph√∫t
                            </label>
                        </div>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function handleLateRepetitive(element) {
            const subContainer = document.getElementById('late_repetitive_sub');
            formData.late_repetitive = 'yes';
            
            const subHTML = `
                <div class="sub-question">
                    <h4>Th·ªùi gian:</h4>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="late_duration" value="<30" onchange="formData.late_duration = this.value; forceUpdateSummary();">
                            < 30 ph√∫t
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="late_duration" value="‚â•30" onchange="formData.late_duration = this.value; forceUpdateSummary();">
                            ‚â• 30 ph√∫t
                        </label>
                    </div>
                </div>
            `;
            
            subContainer.innerHTML = subHTML;
            subContainer.classList.remove('hidden');
            forceUpdateSummary();
        }
        
        function updateWorryingFeatures() {
            const checkedFeatures = Array.from(document.querySelectorAll('input[name="worrying_features"]:checked'))
                .map(cb => cb.value);
            formData.worrying_features = checkedFeatures;
            updateProgress();
            forceUpdateSummary();
        }
        
        function updateWorryingFeaturesNonRep() {
            const checkedFeatures = Array.from(document.querySelectorAll('input[name="worrying_features_nonrep"]:checked'))
                .map(cb => cb.value);
            formData.worrying_features_nonrep = checkedFeatures;
            updateProgress();
            forceUpdateSummary();
        }
        
        function handleAcceleration(element) {
            updateProgress();
            const value = element.value;
            const subContainer = document.getElementById('acceleration_sub_questions');
            
            formData.acceleration = value;
            
            let subHTML = '';
            
            if (value === 'present') {
                subHTML = `
                    <div class="sub-question">
                        <h4>Nh·ªãp tƒÉng c√≥ bi·∫øn m·∫•t sau nh·ªãp gi·∫£m kh√¥ng?</h4>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="acceleration_disappear" value="yes" onchange="formData.acceleration_disappear = this.value; updateProgress(); forceUpdateSummary();">
                                C√≥ - bi·∫øn m·∫•t sau nh·ªãp gi·∫£m
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="acceleration_disappear" value="no" onchange="formData.acceleration_disappear = this.value; updateProgress(); forceUpdateSummary();">
                                Kh√¥ng - v·∫´n c√≥ sau nh·ªãp gi·∫£m
                            </label>
                        </div>
                    </div>
                `;
            }
            
            if (subHTML) {
                subContainer.innerHTML = subHTML;
                subContainer.classList.remove('hidden');
            } else {
                subContainer.classList.add('hidden');
            }
            
            forceUpdateSummary();
        }
        
        function analyzeResults() {
            // Reset unclassified flag
            formData.nice_unclassified = false;
            
            const results = {
                nice: analyzeNICE(),
                acog: analyzeACOG(),
                rcog: analyzeRCOG(),
                figo: analyzeFIGO(),
                japanese5: analyzeJapanese5(),
                physiological: analyzePhysiological()
            };
            
            analysisResults = results;
            displayResults(results);
            
            // Enable export, save and reset buttons
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        }
        
        async function saveDataToServer() {
            if (!analysisResults) {
                showStatusMessage('Vui l√≤ng ph√¢n t√≠ch k·∫øt qu·∫£ tr∆∞·ªõc khi l∆∞u d·ªØ li·ªáu', 'error');
                return;
            }
            
            // X√°c nh·∫≠n tr∆∞·ªõc khi g·ª≠i
            const patientId = document.getElementById('patientId').value.trim();
            let confirmMessage = 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u d·ªØ li·ªáu CTG n√†y l√™n Google Sheets?\n\nD·ªØ li·ªáu bao g·ªìm:\n‚úÖ K·∫øt qu·∫£ 6 h·ªá th·ªëng ph√¢n lo·∫°i\n‚úÖ Th√¥ng tin CTG chi ti·∫øt\n‚úÖ ·∫¢nh CTG (n·∫øu c√≥) ‚Üí Upload l√™n Google Drive';
            if (patientId) {
                confirmMessage += `\n‚úÖ ID B·ªánh nh√¢n: ${patientId}`;
            }
            
            const confirmed = confirm(confirmMessage);
            if (!confirmed) return;
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang g·ª≠i
            showStatusMessage('‚è≥ ƒêang l∆∞u d·ªØ li·ªáu v√† upload ·∫£nh l√™n Google Drive...', 'loading');
            document.getElementById('saveBtn').disabled = true;
            
            try {
                // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒë·∫ßy ƒë·ªß
                const payload = {
                    timestamp: new Date().toISOString(),
                    patientId: patientId || '',
                    formData: formData,
                    analysisResults: analysisResults,
                    ctgImage: ctgImageData,
                    summary: generateDataSummary(),
                    detailedResults: generateDetailedResults()
                };
                
                console.log('Sending payload:', payload);
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = '‚úÖ L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!';
                    if (result.imageUrl && result.imageUrl !== 'Kh√¥ng c√≥ ·∫£nh') {
                        message += `\nüñºÔ∏è ·∫¢nh CTG: ${result.imageUrl}`;
                    }
                    if (patientId) {
                        message += `\nüè• ID B·ªánh nh√¢n: ${patientId}`;
                    }
                    showStatusMessage(message, 'success');
                } else {
                    showStatusMessage('‚ùå L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu'), 'error');
                }
                
            } catch (error) {
                console.error('Error saving data:', error);
                
                // Fallback method
                try {
                    const payload = {
                        timestamp: new Date().toISOString(),
                        patientId: patientId || '',
                        formData: formData,
                        analysisResults: analysisResults,
                        ctgImage: ctgImageData,
                        summary: generateDataSummary(),
                        detailedResults: generateDetailedResults()
                    };
                    
                    const formData_send = new FormData();
                    formData_send.append('data', JSON.stringify(payload));
                    
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData_send,
                        mode: 'no-cors'
                    });
                    
                    showStatusMessage('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i! (Ki·ªÉm tra Google Sheets ƒë·ªÉ x√°c nh·∫≠n)', 'success');
                    
                } catch (error2) {
                    showStatusMessage(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}\n\nüîß Ki·ªÉm tra:\n1. Apps Script ƒë√£ deploy ch∆∞a?\n2. Sheet ID ƒë√£ ƒë√∫ng ch∆∞a?\n3. ƒê√£ authorize quy·ªÅn Drive & Sheets ch∆∞a?`, 'error');
                }
            } finally {
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        function generateDetailedResults() {
            // T·∫°o d·ªØ li·ªáu chi ti·∫øt cho 6 h·ªá th·ªëng ph√¢n lo·∫°i
            const results = {};
            
            if (analysisResults.nice) {
                results.nice = analysisResults.nice.classification;
            }
            if (analysisResults.figo) {
                results.figo = analysisResults.figo.classification;
            }
            if (analysisResults.rcog) {
                results.rcog = analysisResults.rcog.classification;
            }
            if (analysisResults.acog) {
                results.acog = analysisResults.acog.classification;
            }
            if (analysisResults.japanese5) {
                results.japanese5 = analysisResults.japanese5.classification;
            }
            if (analysisResults.physiological) {
                results.physiological = analysisResults.physiological.classification;
            }
            
            // X·ª≠ l√Ω g√≤ t·ª≠ cung: normal ho·∫∑c hyper
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                if (contraction.value === 'normal') {
                    results.uterine_contraction = 'normal';
                } else {
                    results.uterine_contraction = 'hyper'; // suspicious ho·∫∑c prolonged = hyper
                }
            }
            
            return results;
        }
        
        // Callback function cho JSONP
        window.handleResponse = function(response) {
            if (response && response.success) {
                showStatusMessage('‚úÖ L∆∞u d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
            } else {
                showStatusMessage('‚ö†Ô∏è D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i nh∆∞ng kh√¥ng nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n', 'success');
            }
        };
        
        function generateDataSummary() {
            let summary = {};
            
            // G√≤ t·ª≠ cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked');
            if (contraction) {
                summary.uterine_contraction = contraction.value;
            }
            
            // Tim thai cƒÉn b·∫£n
            if (formData.baseline_fhr) {
                summary.baseline_fhr = formData.baseline_fhr;
                if (formData.baseline_stable) summary.baseline_stable = formData.baseline_stable;
                if (formData.baseline_100_109_type) summary.baseline_100_109_type = formData.baseline_100_109_type;
            }
            
            // Dao ƒë·ªông n·ªôi t·∫°i
            if (formData.variability) {
                summary.variability = formData.variability;
                if (formData.minimal_duration) summary.minimal_duration = formData.minimal_duration;
                if (formData.marked_duration) summary.marked_duration = formData.marked_duration;
            }
            
            // Nh·ªãp gi·∫£m
            if (formData.decelerations) {
                summary.decelerations = formData.decelerations;
                if (formData.variable_severity) summary.variable_severity = formData.variable_severity;
                if (formData.late_severity) summary.late_severity = formData.late_severity;
                if (formData.prolonged_severity) summary.prolonged_severity = formData.prolonged_severity;
            }
            
            // Nh·ªãp tƒÉng
            if (formData.acceleration) {
                summary.acceleration = formData.acceleration;
                if (formData.acceleration_disappear) summary.acceleration_disappear = formData.acceleration_disappear;
            }
            
            return summary;
        }
        
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y (tr·ª´ loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function resetForm() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu ƒë√°nh gi√° m·ªõi?')) {
                // Reset form data
                formData = {};
                ctgImageData = null;
                analysisResults = null;
                
                // Reset all form inputs
                document.querySelectorAll('input[type="radio"]').forEach(input => {
                    input.checked = false;
                    input.closest('.radio-item').classList.remove('selected');
                });
                
                document.querySelectorAll('input[type="checkbox"]').forEach(input => {
                    input.checked = false;
                    input.closest('.checkbox-item').classList.remove('selected');
                });
                
                // Reset file inputs and text inputs
                document.getElementById('ctgImage').value = '';
                document.getElementById('patientId').value = '';
                
                // Reset image display
                const container = document.getElementById('stickyImageContainer');
                container.innerHTML = '<div class="no-image">Ch∆∞a c√≥ ·∫£nh CTG. T·∫£i l√™n ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã t·∫°i ƒë√¢y.</div>';
                
                // Hide all sub-questions
                document.querySelectorAll('[id$="_sub_questions"]').forEach(element => {
                    element.classList.add('hidden');
                    element.innerHTML = '';
                });
                
                // Reset progress bar
                document.getElementById('progressFill').style.width = '0%';
                
                // Hide summary
                document.getElementById('ctg_summary').style.display = 'none';
                
                // Reset results display
                document.getElementById('results_container').innerHTML = `
                    <p style="text-align: center; color: #7f8c8d; font-style: italic;">
                        Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ xem k·∫øt qu·∫£ ph√¢n t√≠ch
                    </p>
                `;
                
                // Hide status message
                document.getElementById('statusMessage').style.display = 'none';
                
                // Disable buttons
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('saveBtn').disabled = true;
                document.getElementById('resetBtn').disabled = true;
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function analyzeNICE() {
            let scores = { white: 0, yellow: 0, red: 0 };
            let details = [];
            let reasoningDetails = [];
            
            // G√≤ t·ª≠ cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked')?.value;
            if (contraction === 'normal') {
                scores.white++;
                reasoningDetails.push('G√≤ t·ª≠ cung < 5 c∆°n/10 ph√∫t = B√¨nh th∆∞·ªùng (Tr·∫Øng)');
            } else if (contraction === 'suspicious' || contraction === 'prolonged') {
                scores.yellow++;
                reasoningDetails.push('G√≤ t·ª≠ cung ‚â• 5 c∆°n/10 ph√∫t ho·∫∑c k√©o d√†i ‚â• 2 ph√∫t = Nghi ng·ªù (V√†ng)');
            }
            
            // Tim thai cƒÉn b·∫£n
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                scores.white++;
                reasoningDetails.push('Tim thai 110-160 bpm ·ªïn ƒë·ªãnh, ph√π h·ª£p tu·ªïi thai = B√¨nh th∆∞·ªùng (Tr·∫Øng)');
            } else if (baseline === '100-109' && formData.baseline_100_109_type === 'existing') {
                scores.white++;
                reasoningDetails.push('Tim thai 100-109 bpm (ƒë√£ c√≥ t·ª´ tr∆∞·ªõc) = B√¨nh th∆∞·ªùng (Tr·∫Øng)');
            } else if (baseline === '100-109' && formData.baseline_100_109_type === 'new') {
                scores.yellow++;
                reasoningDetails.push('Tim thai 100-109 bpm (m·ªõi xu·∫•t hi·ªán) = Nghi ng·ªù (V√†ng)');
            } else if (baseline === '110-160' && (formData.baseline_increase_20_normal)) {
                scores.yellow++;
                reasoningDetails.push('Tim thai tƒÉng ‚â• 20 bpm t·ª´ ƒë·∫ßu chuy·ªÉn d·∫° = Nghi ng·ªù (V√†ng)');
            } else if (baseline === '<80' || baseline === '80-100') {
                scores.red++;
                reasoningDetails.push('Tim thai < 100 bpm = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            } else if (baseline === '160-179' || baseline === '>180') {
                scores.red++;
                reasoningDetails.push('Tim thai > 160 bpm = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            } else if (baseline === 'unidentifiable') {
                scores.yellow++;
                reasoningDetails.push('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c baseline = Nghi ng·ªù (V√†ng)');
            }
            
            // Dao ƒë·ªông n·ªôi t·∫°i
            const variability = formData.variability;
            if (variability === 'moderate') {
                scores.white++;
                reasoningDetails.push('Dao ƒë·ªông n·ªôi t·∫°i 5-25 bpm = B√¨nh th∆∞·ªùng (Tr·∫Øng)');
            } else if (variability === 'minimal' && formData.minimal_duration === '30-50') {
                scores.yellow++;
                reasoningDetails.push('Dao ƒë·ªông < 5 bpm trong 30-50 ph√∫t = Nghi ng·ªù (V√†ng)');
            } else if (variability === 'marked' && formData.marked_duration === '‚â§10') {
                scores.yellow++;
                reasoningDetails.push('Dao ƒë·ªông > 25 bpm trong ‚â§ 10 ph√∫t = Nghi ng·ªù (V√†ng)');
            } else if (variability === 'minimal' && formData.minimal_duration === '>50') {
                scores.red++;
                reasoningDetails.push('Dao ƒë·ªông < 5 bpm > 50 ph√∫t = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            } else if (variability === 'marked' && formData.marked_duration === '>10') {
                scores.red++;
                reasoningDetails.push('Dao ƒë·ªông > 25 bpm > 10 ph√∫t = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            } else if (variability === 'sinusoidal') {
                scores.red++;
                reasoningDetails.push('Dao ƒë·ªông d·∫°ng h√¨nh sin = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            } else if (variability === 'undetectable') {
                scores.red++;
                reasoningDetails.push('Dao ƒë·ªông kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c = B·∫•t th∆∞·ªùng (ƒê·ªè)');
            }
            
            // Nh·ªãp gi·∫£m (logic ph·ª©c t·∫°p)
            analyzeDecelerationsNICE(scores, reasoningDetails);
            
            // K·∫øt lu·∫≠n NICE
            let classification, color, management;
            if (formData.nice_unclassified) {
                classification = 'KH√îNG PH√ÇN LO·∫†I ƒê∆Ø·ª¢C';
                color = 'unclassified';
                management = 'C·∫ßn ƒë√°nh gi√° l√¢m s√†ng v√† √°p d·ª•ng c√°c ti√™u chu·∫©n kh√°c';
                details.push('C√≥ tr∆∞·ªùng h·ª£p kh√¥ng ph√¢n lo·∫°i ƒë∆∞·ª£c trong NICE 2022');
            } else if (scores.red > 0 || scores.yellow >= 2) {
                classification = 'B·∫§T TH∆Ø·ªúNG';
                color = 'abnormal';
                management = 'ƒê√°nh gi√° to√†n di·ªán bao g·ªìm m·∫π; h·ªìi sinh, h·ªìi s·ª©c; c√¢n nh·∫Øc k√≠ch th√≠ch ƒë·∫ßu thai, lo·∫°i tr·ª´ tai bi·∫øn c·∫•p v√† c√¢n nh·∫Øc CDTK ngay';
                details.push('1 ti√™u ch√≠ ƒë·ªè ho·∫∑c ‚â• 2 ti√™u ch√≠ v√†ng ‚Üí C·∫ßn can thi·ªáp ngay');
            } else if (scores.yellow === 1) {
                classification = 'NGHI NG·ªú';
                color = 'suspicious';
                management = 'ƒê√°nh gi√° to√†n di·ªán, bao g·ªìm c·∫£ m·∫π; h·ªèi cƒÉn nguy√™n, h·ªìi s·ª©c; c√¢n nh·∫Øc k√≠ch th√≠ch ƒë·∫ßu thai ho·∫∑c th√∫c ƒë·∫©y/chuy·ªÉn d·∫°/CTDK';
                details.push('1 ti√™u ch√≠ v√†ng ‚Üí ƒê√°nh gi√° to√†n di·ªán, theo d√µi s√°t');
            } else {
                classification = 'B√åNH TH∆Ø·ªúNG';
                color = 'normal';
                management = 'Ti·∫øp t·ª•c theo d√µi';
                details.push('4 ti√™u ch√≠ ƒë·ªÅu tr·∫Øng ‚Üí Ti·∫øp t·ª•c theo d√µi');
            }
            
            details.push(`üîß X·ª≠ tr√≠: ${management}`);
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'NICE 2022'
            };
        }
        
        function analyzeDecelerationsNICE(scores, details) {
            const decelerations = formData.decelerations || [];
            
            if (decelerations.includes('none') || decelerations.includes('early')) {
                scores.white++;
                details.push('Nh·ªãp gi·∫£m: B√¨nh th∆∞·ªùng (kh√¥ng c√≥ ho·∫∑c ch·ªâ c√≥ nh·ªãp gi·∫£m s·ªõm)');
                return;
            }
            
            let hasUnclassified = false;
            
            if (decelerations.includes('variable')) {
                if (formData.variable_repetitive === 'yes') {
                    if (formData.worrying_features && formData.worrying_features.length > 0) {
                        if (formData.variable_duration === '<30') {
                            scores.yellow++;
                            details.push('Nh·ªãp gi·∫£m: Nghi ng·ªù (b·∫•t ƒë·ªãnh l·∫∑p l·∫°i c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i < 30 ph√∫t)');
                        } else {
                            scores.red++;
                            details.push('Nh·ªãp gi·∫£m: B·∫•t th∆∞·ªùng (b·∫•t ƒë·ªãnh l·∫∑p l·∫°i c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i ‚â• 30 ph√∫t)');
                        }
                    } else {
                        // Tr∆∞·ªùng h·ª£p unclassified: Recurrent variable decelerations kh√¥ng c√≥ concerning features
                        hasUnclassified = true;
                        details.push('Nh·ªãp gi·∫£m: Kh√¥ng ph√¢n lo·∫°i ƒë∆∞·ª£c (b·∫•t ƒë·ªãnh l·∫∑p l·∫°i kh√¥ng c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i)');
                    }
                } else if (formData.variable_repetitive === 'no') {
                    if (formData.worrying_features_nonrep && formData.worrying_features_nonrep.length > 0) {
                        if (formData.variable_nonrep_duration === '<30') {
                            // Tr∆∞·ªùng h·ª£p unclassified: Variable decelerations with concerning features, non-recurrent, < 30 ph√∫t
                            hasUnclassified = true;
                            details.push('Nh·ªãp gi·∫£m: Kh√¥ng ph√¢n lo·∫°i ƒë∆∞·ª£c (b·∫•t ƒë·ªãnh kh√¥ng l·∫∑p l·∫°i c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i < 30 ph√∫t)');
                        } else {
                            scores.yellow++;
                            details.push('Nh·ªãp gi·∫£m: Nghi ng·ªù (b·∫•t ƒë·ªãnh kh√¥ng l·∫∑p l·∫°i c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i ‚â• 30 ph√∫t)');
                        }
                    } else {
                        scores.white++;
                        details.push('Nh·ªãp gi·∫£m: B√¨nh th∆∞·ªùng (b·∫•t ƒë·ªãnh kh√¥ng c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i)');
                    }
                }
            }
            
            if (decelerations.includes('late')) {
                if (formData.late_repetitive === 'yes') {
                    if (formData.late_duration === '<20') {
                        scores.yellow++;
                        details.push('Nh·ªãp gi·∫£m: Nghi ng·ªù (mu·ªôn l·∫∑p l·∫°i < 30 ph√∫t)');
                    } else if (formData.late_duration === '20-30') {
                        scores.yellow++;
                        details.push('Nh·ªãp gi·∫£m: Nghi ng·ªù (mu·ªôn l·∫∑p l·∫°i 20-30 ph√∫t)');
                    } else {
                        scores.red++;
                        details.push('Nh·ªãp gi·∫£m: B·∫•t th∆∞·ªùng (mu·ªôn l·∫∑p l·∫°i > 30 ph√∫t)');
                    }
                } else if (formData.late_repetitive === 'no') {
                    // Tr∆∞·ªùng h·ª£p unclassified: Late decelerations kh√¥ng l·∫∑p l·∫°i
                    hasUnclassified = true;
                    details.push('Nh·ªãp gi·∫£m: Kh√¥ng ph√¢n lo·∫°i ƒë∆∞·ª£c (nh·ªãp gi·∫£m mu·ªôn kh√¥ng l·∫∑p l·∫°i)');
                }
            }
            
            if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>3') {
                    scores.red++;
                    details.push('Nh·ªãp gi·∫£m: B·∫•t th∆∞·ªùng (k√©o d√†i > 3 ph√∫t = tim thai ch·∫≠m c·∫•p)');
                }
            }
            
            // N·∫øu c√≥ tr∆∞·ªùng h·ª£p unclassified, ƒë√°nh d·∫•u ƒë·ªÉ x·ª≠ l√Ω ri√™ng
            if (hasUnclassified) {
                formData.nice_unclassified = true;
            }
        }
        
        function analyzeACOG() {
            // Nh√≥m I: T·∫•t c·∫£ b√¨nh th∆∞·ªùng
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            
            let reasoningDetails = [];
            
            const hasNormalBaseline = baseline === '110-160' && formData.baseline_stable === 'yes';
            const hasModerateVariability = variability === 'moderate';
            const hasNoLateOrVariable = !decelerations.includes('late') && !decelerations.includes('variable');
            
            // Nh√≥m III: C√°c ti√™u ch√≠ nghi√™m tr·ªçng
            const hasAbsentVariability = variability === 'undetectable';
            const hasSinusoidal = variability === 'sinusoidal';
            const hasBradycardia = baseline === '<80' || baseline === '80-100' || baseline === '100-109'; // C·∫≠p nh·∫≠t: < 110 bpm
            const hasRecurrentLate = decelerations.includes('late') && formData.late_repetitive === 'yes';
            const hasRecurrentVariable = decelerations.includes('variable') && formData.variable_repetitive === 'yes';
            
            let classification, color;
            
            if ((hasAbsentVariability && (hasRecurrentLate || hasRecurrentVariable || hasBradycardia)) || hasSinusoidal) {
                classification = 'NH√ìM III';
                color = 'abnormal';
                if (hasAbsentVariability && hasBradycardia) {
                    reasoningDetails.push('Kh√¥ng c√≥ dao ƒë·ªông n·ªôi t·∫°i + tim thai < 110 bpm (nh·ªãp ch·∫≠m) = Nh√≥m III');
                } else if (hasAbsentVariability && (hasRecurrentLate || hasRecurrentVariable)) {
                    reasoningDetails.push('Kh√¥ng c√≥ dao ƒë·ªông n·ªôi t·∫°i + nh·ªãp gi·∫£m l·∫∑p l·∫°i = Nh√≥m III');
                } else if (hasSinusoidal) {
                    reasoningDetails.push('Bi·ªÉu ƒë·ªì d·∫°ng h√¨nh sin = Nh√≥m III');
                }
                reasoningDetails.push('Nh√≥m III: C·∫ßn can thi·ªáp ngay l·∫≠p t·ª©c');
            } else if (hasNormalBaseline && hasModerateVariability && hasNoLateOrVariable) {
                classification = 'NH√ìM I';
                color = 'normal';
                reasoningDetails.push('Tim thai 110-160 bpm + dao ƒë·ªông trung b√¨nh + kh√¥ng c√≥ nh·ªãp gi·∫£m mu·ªôn/b·∫•t ƒë·ªãnh = Nh√≥m I');
                reasoningDetails.push('Nh√≥m I: Thai nhi kh·ªèe m·∫°nh, theo d√µi b√¨nh th∆∞·ªùng');
            } else {
                classification = 'NH√ìM II';
                color = 'suspicious';
                reasoningDetails.push('Kh√¥ng ƒë·∫°t ti√™u ch√≠ Nh√≥m I v√† kh√¥ng c√≥ d·∫•u hi·ªáu Nh√≥m III = Nh√≥m II');
                reasoningDetails.push('Nh√≥m II: C·∫ßn theo d√µi s√°t, ƒë√°nh gi√° th√™m');
                
                // Th√™m chi ti·∫øt cho Nh√≥m II
                if (hasBradycardia) {
                    reasoningDetails.push('‚Ä¢ Tim thai < 110 bpm (nh·ªãp ch·∫≠m) - theo d√µi s√°t');
                }
            }
            
            return {
                classification,
                color,
                details: reasoningDetails,
                system: 'ACOG 2009'
            };
        }
        
        function analyzeRCOG() {
            let reassuring = 0;
            let nonReassuring = 0;
            let abnormal = 0;
            let details = [];
            let reasoningDetails = [];
            
            // Tim thai cƒÉn b·∫£n
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                reassuring++;
                reasoningDetails.push('Tim thai 110-160 bpm ·ªïn ƒë·ªãnh = An t√¢m');
            } else if (baseline === '100-109' || baseline === '160-179') {
                nonReassuring++;
                reasoningDetails.push('Tim thai 100-109 bpm ho·∫∑c 160-179 bpm = Kh√¥ng an t√¢m');
            } else if (baseline === '<80' || baseline === '80-100' || baseline === '>180' || baseline === 'unidentifiable') {
                abnormal++;
                reasoningDetails.push('Tim thai < 100 bpm ho·∫∑c > 180 bpm ho·∫∑c kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c = B·∫•t th∆∞·ªùng');
            } else {
                nonReassuring++;
                reasoningDetails.push('Tim thai kh√¥ng ·ªïn ƒë·ªãnh = Kh√¥ng an t√¢m');
            }
            
            // Dao ƒë·ªông n·ªôi t·∫°i
            const variability = formData.variability;
            if (variability === 'moderate' || variability === 'marked') {
                reassuring++;
                reasoningDetails.push('Dao ƒë·ªông ‚â• 5 bpm = An t√¢m');
            } else if (variability === 'minimal') {
                if (formData.minimal_duration === '>50') {
                    abnormal++;
                    reasoningDetails.push('Dao ƒë·ªông < 5 bpm trong ‚â• 90 ph√∫t = B·∫•t th∆∞·ªùng');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Dao ƒë·ªông < 5 bpm trong 40-90 ph√∫t = Kh√¥ng an t√¢m');
                }
            } else if (variability === 'undetectable') {
                abnormal++;
                reasoningDetails.push('Dao ƒë·ªông kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c = B·∫•t th∆∞·ªùng');
            } else if (variability === 'sinusoidal') {
                abnormal++;
                reasoningDetails.push('Dao ƒë·ªông h√¨nh sin ‚â• 10 ph√∫t = B·∫•t th∆∞·ªùng');
            }
            
            // Nh·ªãp gi·∫£m
            const decelerations = formData.decelerations || [];
            if (decelerations.includes('none')) {
                reassuring++;
                reasoningDetails.push('Kh√¥ng c√≥ nh·ªãp gi·∫£m = An t√¢m');
            } else if (decelerations.includes('early')) {
                nonReassuring++;
                reasoningDetails.push('Nh·ªãp gi·∫£m s·ªõm = Kh√¥ng an t√¢m');
            } else if (decelerations.includes('variable')) {
                // Nh·ªãp gi·∫£m bi·∫øn ƒë·ªïi c√≥ d·∫•u hi·ªáu ƒë√°ng ng·∫°i = kh√¥ng ƒëi·ªÉn h√¨nh = b·∫•t th∆∞·ªùng
                const hasWorryingFeatures = (formData.worrying_features && formData.worrying_features.length > 0) ||
                                          (formData.worrying_features_nonrep && formData.worrying_features_nonrep.length > 0);
                
                if (formData.variable_severity === 'severe' || hasWorryingFeatures) {
                    abnormal++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m bi·∫øn ƒë·ªïi kh√¥ng ƒëi·ªÉn h√¨nh (n·∫∑ng ho·∫∑c c√≥ ƒë·∫∑c ƒëi·ªÉm ƒë√°ng ng·∫°i) = B·∫•t th∆∞·ªùng');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m bi·∫øn ƒë·ªïi ƒëi·ªÉn h√¨nh = Kh√¥ng an t√¢m');
                }
            } else if (decelerations.includes('late')) {
                abnormal++;
                reasoningDetails.push('Nh·ªãp gi·∫£m mu·ªôn = B·∫•t th∆∞·ªùng');
            } else if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>3') {
                    abnormal++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i > 3 ph√∫t = B·∫•t th∆∞·ªùng');
                } else {
                    nonReassuring++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i ‚â§ 3 ph√∫t = Kh√¥ng an t√¢m');
                }
            }
            
            // Nh·ªãp tƒÉng
            if (formData.acceleration === 'present') {
                reassuring++;
                reasoningDetails.push('C√≥ nh·ªãp tƒÉng = An t√¢m');
            } else if (formData.acceleration === 'absent') {
                nonReassuring++;
                reasoningDetails.push('V·∫Øng m·∫∑t nh·ªãp tƒÉng = Kh√¥ng an t√¢m');
            }
            
            // K·∫øt lu·∫≠n RCOG
            let classification, color;
            if (abnormal >= 1 || nonReassuring >= 2) {
                classification = 'B·∫§T TH∆Ø·ªúNG';
                color = 'abnormal';
                details.push('‚â• 1 ƒë·∫∑c ƒëi·ªÉm B·∫•t th∆∞·ªùng ho·∫∑c ‚â• 2 ƒë·∫∑c ƒëi·ªÉm Kh√¥ng an t√¢m');
            } else if (nonReassuring === 1) {
                classification = 'NGHI NG·ªú (Kh√¥ng an t√¢m)';
                color = 'suspicious';
                details.push('1 ƒë·∫∑c ƒëi·ªÉm Kh√¥ng an t√¢m');
            } else if (reassuring === 4) {
                classification = 'B√åNH TH∆Ø·ªúNG (An t√¢m)';
                color = 'normal';
                details.push('4 ƒë·∫∑c ƒëi·ªÉm ƒë·ªÅu An t√¢m');
            } else {
                classification = 'NGHI NG·ªú (Kh√¥ng ƒë·ªß th√¥ng tin)';
                color = 'suspicious';
                details.push('Kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ ph√¢n lo·∫°i');
            }
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'RCOG 2001'
            };
        }
        
        function analyzeFIGO() {
            let normal = 0;
            let suspicious = 0;
            let pathological = 0;
            let details = [];
            let reasoningDetails = [];
            
            // Tim thai cƒÉn b·∫£n
            const baseline = formData.baseline_fhr;
            if (baseline === '110-160' && formData.baseline_stable === 'yes') {
                normal++;
                reasoningDetails.push('Tim thai 110-160 bpm ·ªïn ƒë·ªãnh = B√¨nh th∆∞·ªùng');
            } else if (baseline === '<80' || baseline === '80-100') {
                pathological++;
                reasoningDetails.push('Tim thai < 100 bpm = B·ªánh l√Ω');
            } else {
                suspicious++;
                reasoningDetails.push('Tim thai thi·∫øu √≠t nh·∫•t m·ªôt ƒë·∫∑c ƒëi·ªÉm b√¨nh th∆∞·ªùng = Nghi ng·ªù');
            }
            
            // Dao ƒë·ªông
            const variability = formData.variability;
            const hasReducedVariability = variability === 'minimal' || variability === 'undetectable';
            
            if (variability === 'moderate') {
                normal++;
                reasoningDetails.push('Dao ƒë·ªông 5-25 bpm = B√¨nh th∆∞·ªùng');
            } else if (variability === 'undetectable' || variability === 'marked' || variability === 'sinusoidal') {
                pathological++;
                if (variability === 'undetectable') {
                    reasoningDetails.push('Dao ƒë·ªông gi·∫£m (kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c) = B·ªánh l√Ω');
                } else if (variability === 'marked') {
                    reasoningDetails.push('Dao ƒë·ªông tƒÉng (> 25 bpm) = B·ªánh l√Ω');
                } else {
                    reasoningDetails.push('Dao ƒë·ªông d·∫°ng h√¨nh sin = B·ªánh l√Ω');
                }
            } else {
                suspicious++;
                reasoningDetails.push('Dao ƒë·ªông thi·∫øu √≠t nh·∫•t m·ªôt ƒë·∫∑c ƒëi·ªÉm b√¨nh th∆∞·ªùng = Nghi ng·ªù');
            }
            
            // Nh·ªãp gi·∫£m
            const decelerations = formData.decelerations || [];
            if (decelerations.includes('none')) {
                normal++;
                reasoningDetails.push('Kh√¥ng c√≥ nh·ªãp gi·∫£m l·∫∑p l·∫°i = B√¨nh th∆∞·ªùng');
            } else if (decelerations.includes('late') && formData.late_repetitive === 'yes') {
                // Nh·ªãp gi·∫£m mu·ªôn l·∫∑p l·∫°i
                if (formData.late_duration === '>30') {
                    pathological++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m mu·ªôn l·∫∑p l·∫°i > 30 ph√∫t = B·ªánh l√Ω');
                } else if (formData.late_duration === '20-30' && hasReducedVariability) {
                    pathological++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m mu·ªôn l·∫∑p l·∫°i 20-30 ph√∫t + gi·∫£m dao ƒë·ªông n·ªôi t·∫°i = B·ªánh l√Ω');
                } else {
                    suspicious++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m mu·ªôn l·∫∑p l·∫°i < 30 ph√∫t = Nghi ng·ªù');
                }
            } else if (decelerations.includes('prolonged')) {
                if (formData.prolonged_duration === '>2') {
                    pathological++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i > 2 ph√∫t = B·ªánh l√Ω');
                } else if (formData.prolonged_occurrence_time === '>30') {
                    pathological++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i l·∫∑p l·∫°i > 30 ph√∫t = B·ªánh l√Ω');
                } else if (formData.prolonged_occurrence_time === '20-30' && hasReducedVariability) {
                    pathological++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i l·∫∑p l·∫°i 20-30 ph√∫t + gi·∫£m dao ƒë·ªông n·ªôi t·∫°i = B·ªánh l√Ω');
                } else {
                    suspicious++;
                    reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i = Nghi ng·ªù');
                }
            } else if (decelerations.includes('variable') || decelerations.includes('early')) {
                suspicious++;
                reasoningDetails.push('C√≥ nh·ªãp gi·∫£m nh∆∞ng kh√¥ng ƒë·ªß ti√™u ch√≠ b·ªánh l√Ω = Nghi ng·ªù');
            }
            
            // K·∫øt lu·∫≠n
            let classification, color, management;
            if (pathological > 0) {
                classification = 'B·ªÜNH L√ù';
                color = 'abnormal';
                management = 'H√†nh ƒë·ªông ngay ƒë·ªÉ kh·∫Øc ph·ª•c t√¨nh tr·∫°ng thi·∫øu oxy m√°u n·∫øu ƒëi·ªÅu n√†y kh√¥ng th·ªÉ ch·∫©n ƒëo√°n ch·∫≠m tr·ªÖ thai k·ª≥. Trong t√¨nh hu·ªëng c·∫•p c·ª©u (sa d√¢y r·ªën, v·ª° t·ª≠ cung, nhau bong non...), c·∫ßn CDTK ngay l·∫≠p t·ª©c';
                details.push('Thai nhi c√≥ kh·∫£ nƒÉng cao b·ªã thi·∫øu oxy/toan m√°u');
            } else if (suspicious > 0) {
                classification = 'NGHI NG·ªú';
                color = 'suspicious';
                management = 'X√°c ƒë·ªãnh v√† kh·∫Øc ph·ª•c nguy√™n nh√¢n; theo d√µi s√°t ho·∫∑c ƒë√°nh gi√° th√™m t√¨nh tr·∫°ng oxy thai b·∫±ng c√°c ph∆∞∆°ng ph√°p kh√°c';
                details.push('Thai nhi c√≥ nguy c∆° (th·∫•p) b·ªã thi·∫øu oxy/toan m√°u');
            } else {
                classification = 'B√åNH TH∆Ø·ªúNG';
                color = 'normal';
                management = 'Kh√¥ng c·∫ßn can thi·ªáp';
                details.push('Thai nhi kh√¥ng b·ªã thi·∫øu oxy/tho√°i toan');
            }
            
            details.push(`üîß X·ª≠ tr√≠: ${management}`);
            
            return {
                classification,
                color,
                details: [...details, ...reasoningDetails],
                system: 'FIGO 2015'
            };
        }
        
        function analyzeJapanese5() {
            // Logic ph·ª©c t·∫°p cho h·ªá th·ªëng 5 m·ª©c
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            
            let level = 1; // M·∫∑c ƒë·ªãnh level 1
            let reasoningDetails = [];
            
            // Logic c∆° b·∫£n d·ª±a tr√™n b·∫£ng trong t√†i li·ªáu
            if (baseline === '110-160' && variability === 'moderate' && decelerations.includes('none')) {
                level = 1;
                reasoningDetails.push('Tim thai 110-160 bpm + dao ƒë·ªông trung b√¨nh + kh√¥ng c√≥ nh·ªãp gi·∫£m = M·ª©c 1');
            } else if ((baseline === '110-160' && variability === 'moderate' && decelerations.includes('early')) ||
                       (baseline === '>180' && variability === 'moderate' && decelerations.includes('none'))) {
                level = 2;
                reasoningDetails.push('Tim thai b√¨nh th∆∞·ªùng + dao ƒë·ªông trung b√¨nh + nh·ªãp gi·∫£m s·ªõm = M·ª©c 2');
            } else if (baseline === '<80' || variability === 'undetectable') {
                level = 4;
                reasoningDetails.push('Tim thai < 80 bpm ho·∫∑c dao ƒë·ªông kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c = M·ª©c 4');
            } else if (variability === 'sinusoidal') {
                level = 4;
                reasoningDetails.push('Dao ƒë·ªông d·∫°ng h√¨nh sin = M·ª©c 4');
            } else {
                level = 3; // M·∫∑c ƒë·ªãnh cho c√°c tr∆∞·ªùng h·ª£p kh√°c
                reasoningDetails.push('C√°c th√¥ng s·ªë kh√°c kh√¥ng ƒë·∫°t m·ª©c 1-2 = M·ª©c 3');
            }
            
            // ƒêi·ªÅu ch·ªânh d·ª±a tr√™n nh·ªãp gi·∫£m n·∫∑ng
            if (decelerations.includes('variable') && formData.variable_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nh·ªãp gi·∫£m b·∫•t ƒë·ªãnh n·∫∑ng ‚Üí TƒÉng l√™n √≠t nh·∫•t M·ª©c 4');
            }
            
            if (decelerations.includes('late') && formData.late_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nh·ªãp gi·∫£m mu·ªôn n·∫∑ng (> 15 bpm t·ª´ baseline) ‚Üí TƒÉng l√™n √≠t nh·∫•t M·ª©c 4');
            }
            
            if (decelerations.includes('prolonged') && formData.prolonged_severity === 'severe') {
                level = Math.max(level, 4);
                reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i n·∫∑ng (ƒëi·ªÉm th·∫•p nh·∫•t < 80 bpm) ‚Üí TƒÉng l√™n √≠t nh·∫•t M·ª©c 4');
            }
            
            // Level 5 cho c√°c tr∆∞·ªùng h·ª£p r·∫•t nghi√™m tr·ªçng
            if ((baseline === '<80' && variability === 'undetectable') ||
                (variability === 'undetectable' && decelerations.includes('variable') && formData.variable_severity === 'severe')) {
                level = 5;
                reasoningDetails.push('Tim thai < 80 bpm + kh√¥ng c√≥ dao ƒë·ªông ho·∫∑c dao ƒë·ªông kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c + nh·ªãp gi·∫£m n·∫∑ng = M·ª©c 5');
            }
            
            let color, management;
            if (level === 1) {
                color = 'normal';
                management = 'Theo d√µi b√¨nh th∆∞·ªùng';
            } else if (level === 2) {
                color = 'normal';
                management = 'Theo d√µi b√¨nh th∆∞·ªùng, ch√∫ √Ω';
            } else if (level === 3) {
                color = 'suspicious';
                management = 'Theo d√µi s√°t, c√¢n nh·∫Øc can thi·ªáp';
            } else if (level === 4) {
                color = 'abnormal';
                management = 'C·∫ßn can thi·ªáp s·ªõm';
            } else {
                color = 'abnormal';
                management = 'C·∫ßn can thi·ªáp ngay l·∫≠p t·ª©c';
            }
            
            reasoningDetails.push(`Khuy·∫øn ngh·ªã: ${management}`);
            
            return {
                classification: `M·ª®C ƒê·ªò ${level}`,
                color,
                details: reasoningDetails,
                system: 'Ph√¢n lo·∫°i 5 m·ª©c (Nh·∫≠t B·∫£n)'
            };
        }
        
        function analyzePhysiological() {
            const baseline = formData.baseline_fhr;
            const variability = formData.variability;
            const decelerations = formData.decelerations || [];
            let reasoningDetails = [];
            
            // Thi·∫øu oxy c·∫•p
            if (decelerations.includes('prolonged') && formData.prolonged_duration === '>3') {
                reasoningDetails.push('Nh·ªãp gi·∫£m k√©o d√†i > 3 ph√∫t ‚Üí Nghi ng·ªù tai bi·∫øn s·∫£n khoa');
                reasoningDetails.push('C·∫ßn lo·∫°i tr·ª´: sa d√¢y r·ªën, nhau bong non, v·ª° t·ª≠ cung');
                return {
                    classification: 'THI·∫æU OXY C·∫§P',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            // Thi·∫øu oxy b√°n c·∫•p
            if (formData.time_comparison === 'deceleration_longer') {
                reasoningDetails.push('Th·ªùi gian trong nh·ªãp gi·∫£m > th·ªùi gian ·ªü baseline');
                reasoningDetails.push('Th·ªùi gian trong nh·ªãp gi·∫£m > 90 gi√¢y, th·ªùi gian ·ªü baseline < 30 gi√¢y');
                return {
                    classification: 'THI·∫æU OXY B√ÅN C·∫§P',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            // ƒê√°nh gi√° c√°c y·∫øu t·ªë thi·∫øu oxy di·ªÖn ti·∫øn
            const hasIncreasedBaseline = formData.baseline_increase_10 || formData.baseline_increase_20 || 
                                       formData.baseline_increase_10_normal || formData.baseline_increase_20_normal;
            const hasAbnormalVariability = variability === 'minimal' || variability === 'marked';
            const hasRecurrentDecelerations = (decelerations.includes('variable') && formData.variable_repetitive === 'yes') ||
                                             (decelerations.includes('late') && formData.late_repetitive === 'yes');
            const hasLostAcceleration = (formData.acceleration_disappear === 'yes' || formData.acceleration === 'absent');
            const hasBaselineLonger = formData.time_comparison === 'baseline_longer';
            
            // Thi·∫øu oxy di·ªÖn ti·∫øn m·∫•t b√π (ƒë·ªß 3 ti√™u ch√≠)
            if (hasIncreasedBaseline && hasAbnormalVariability && hasRecurrentDecelerations) {
                reasoningDetails.push('‚úì TƒÉng tim thai cƒÉn b·∫£n (tƒÉng > 10% ho·∫∑c ‚â• 20 bpm)');
                reasoningDetails.push('‚úì Dao ƒë·ªông n·ªôi t·∫°i b·∫•t th∆∞·ªùng (< 5 bpm ho·∫∑c > 25 bpm)');
                reasoningDetails.push('‚úì Nh·ªãp gi·∫£m l·∫∑p l·∫°i (b·∫•t ƒë·ªãnh ho·∫∑c mu·ªôn)');
                reasoningDetails.push('Tim thai cƒÉn b·∫£n c√≥ th·ªÉ gi·∫£m d·∫ßn ki·ªÉu b·∫≠c thang ‚Üí Nguy c∆° cao');
                return {
                    classification: 'THI·∫æU OXY DI·ªÑN TI·∫æN M·∫§T B√ô',
                    color: 'abnormal',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            // Thi·∫øu oxy di·ªÖn ti·∫øn c√≤n b√π (ƒë·ªß 4 ti√™u ch√≠)
            if (hasIncreasedBaseline && variability === 'moderate' && hasBaselineLonger && hasLostAcceleration) {
                reasoningDetails.push('‚úì TƒÉng tim thai cƒÉn b·∫£n + dao ƒë·ªông n·ªôi t·∫°i b√¨nh th∆∞·ªùng');
                reasoningDetails.push('‚úì Th·ªùi gian ·ªü baseline > th·ªùi gian trong nh·ªãp gi·∫£m');
                reasoningDetails.push('‚úì M·∫•t nh·ªãp tƒÉng sau nh·ªãp gi·∫£m');
                reasoningDetails.push('C∆° th·ªÉ thai nhi v·∫´n ƒëang b√π tr·ª´ ƒë∆∞·ª£c ‚Üí Theo d√µi 30-60 ph√∫t');
                return {
                    classification: 'THI·∫æU OXY DI·ªÑN TI·∫æN C√íN B√ô',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            // G·ª£i √Ω thi·∫øu oxy di·ªÖn ti·∫øn m·∫•t b√π (c√≥ 2/3 ti√™u ch√≠)
            let misbufferCount = 0;
            if (hasIncreasedBaseline) misbufferCount++;
            if (hasAbnormalVariability) misbufferCount++;
            if (hasRecurrentDecelerations) misbufferCount++;
            
            if (misbufferCount >= 2) {
                let presentCriteria = [];
                if (hasIncreasedBaseline) presentCriteria.push('TƒÉng tim thai cƒÉn b·∫£n');
                if (hasAbnormalVariability) presentCriteria.push('Dao ƒë·ªông n·ªôi t·∫°i b·∫•t th∆∞·ªùng');
                if (hasRecurrentDecelerations) presentCriteria.push('Nh·ªãp gi·∫£m l·∫∑p l·∫°i');
                
                reasoningDetails.push('C√≥ 2/3 ti√™u ch√≠ thi·∫øu oxy di·ªÖn ti·∫øn m·∫•t b√π:');
                reasoningDetails.push('‚úì ' + presentCriteria.join(', ‚úì '));
                reasoningDetails.push('‚Üí Theo d√µi s√°t, chu·∫©n b·ªã can thi·ªáp');
                return {
                    classification: 'G·ª¢I √ù THI·∫æU OXY DI·ªÑN TI·∫æN M·∫§T B√ô',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            // G·ª£i √Ω thi·∫øu oxy di·ªÖn ti·∫øn c√≤n b√π (c√≥ 2-3/4 ti√™u ch√≠)
            let compensatedCount = 0;
            if (hasIncreasedBaseline) compensatedCount++;
            if (variability === 'moderate') compensatedCount++;
            if (hasBaselineLonger) compensatedCount++;
            if (hasLostAcceleration) compensatedCount++;
            
            if (compensatedCount >= 2) {
                let presentCriteria = [];
                if (hasIncreasedBaseline) presentCriteria.push('TƒÉng tim thai cƒÉn b·∫£n');
                if (variability === 'moderate') presentCriteria.push('Dao ƒë·ªông n·ªôi t·∫°i b√¨nh th∆∞·ªùng');
                if (hasBaselineLonger) presentCriteria.push('Baseline d√†i h∆°n nh·ªãp gi·∫£m');
                if (hasLostAcceleration) presentCriteria.push('M·∫•t nh·ªãp tƒÉng');
                
                reasoningDetails.push(`C√≥ ${compensatedCount}/4 ti√™u ch√≠ thi·∫øu oxy di·ªÖn ti·∫øn c√≤n b√π:`);
                reasoningDetails.push('‚úì ' + presentCriteria.join(', ‚úì '));
                reasoningDetails.push('‚Üí Thai nhi ƒëang c·ªë g·∫Øng b√π tr·ª´, theo d√µi 30-60 ph√∫t');
                return {
                    classification: 'G·ª¢I √ù THI·∫æU OXY DI·ªÑN TI·∫æN C√íN B√ô',
                    color: 'suspicious',
                    details: reasoningDetails,
                    system: 'Ph√¢n lo·∫°i Sinh l√Ω'
                };
            }
            
            reasoningDetails.push('Kh√¥ng c√≥ ƒë·ªß d·∫•u hi·ªáu c·ªßa c√°c pattern thi·∫øu oxy ƒë·∫∑c tr∆∞ng');
            reasoningDetails.push('Thai nhi c√≥ th·ªÉ ƒëang trong t√¨nh tr·∫°ng oxy h√≥a b√¨nh th∆∞·ªùng');
            return {
                classification: 'KH√îNG X√ÅC ƒê·ªäNH THI·∫æU OXY',
                color: 'normal',
                details: reasoningDetails,
                system: 'Ph√¢n lo·∫°i Sinh l√Ω'
            };
        }
        
        function displayResults(results) {
            const container = document.getElementById('results_container');
            
            let html = '';
            
            Object.entries(results).forEach(([systemKey, result]) => {
                let colorClass = 'result-default'; // Default cho c√°c h·ªá th·ªëng kh√°c
                
                // NICE system
                if (result.system === 'NICE 2022') {
                    if (result.classification === 'B√åNH TH∆Ø·ªúNG') {
                        colorClass = 'result-nice-normal';
                    } else if (result.classification === 'NGHI NG·ªú') {
                        colorClass = 'result-nice-suspicious';
                    } else if (result.classification === 'B·∫§T TH∆Ø·ªúNG') {
                        colorClass = 'result-nice-abnormal';
                    } else if (result.classification === 'KH√îNG PH√ÇN LO·∫†I ƒê∆Ø·ª¢C') {
                        colorClass = 'result-nice-unclassified';
                    }
                }
                // Japanese 5-level system
                else if (result.system === 'Ph√¢n lo·∫°i 5 m·ª©c (Nh·∫≠t B·∫£n)') {
                    if (result.classification === 'M·ª®C ƒê·ªò 1') {
                        colorClass = 'result-japanese-1';
                    } else if (result.classification === 'M·ª®C ƒê·ªò 2') {
                        colorClass = 'result-japanese-2';
                    } else if (result.classification === 'M·ª®C ƒê·ªò 3') {
                        colorClass = 'result-japanese-3';
                    } else if (result.classification === 'M·ª®C ƒê·ªò 4') {
                        colorClass = 'result-japanese-4';
                    } else if (result.classification === 'M·ª®C ƒê·ªò 5') {
                        colorClass = 'result-japanese-5';
                    }
                }
                
                html += `
                    <div class="result-card ${colorClass}">
                        <h4>${result.system}</h4>
                        <p><strong>${result.classification}</strong></p>
                        <ul>
                            ${result.details.map(detail => `<li>${detail}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function exportToPDF() {
            if (!analysisResults) {
                alert('Vui l√≤ng ph√¢n t√≠ch k·∫øt qu·∫£ tr∆∞·ªõc khi xu·∫•t PDF');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Thi·∫øt l·∫≠p font cho ti·∫øng Vi·ªát (s·ª≠ d·ª•ng font c√≥ s·∫µn)
            doc.setFont('helvetica', 'normal');
            
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;
            
            // Header
            doc.setFontSize(18);
            doc.text('B√ÅO C√ÅO PH√ÇN T√çCH CTG', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            doc.setFontSize(12);
            doc.text('Ng√†y: ' + new Date().toLocaleDateString('vi-VN'), pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 20;
            
            // Th√™m ·∫£nh CTG n·∫øu c√≥
            if (ctgImageData) {
                try {
                    doc.text('·∫¢nh CTG:', margin, yPosition);
                    yPosition += 10;
                    doc.addImage(ctgImageData, 'JPEG', margin, yPosition, 100, 60);
                    yPosition += 70;
                } catch (error) {
                    console.log('Kh√¥ng th·ªÉ th√™m ·∫£nh v√†o PDF:', error);
                }
            }
            
            // T√≥m t·∫Øt CTG
            doc.setFontSize(14);
            doc.text('1. T√ìM T·∫ÆT TH√îNG S·ªê CTG', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            
            // T·∫°o summary text t·ª´ formData
            let summaryText = '';
            
            // G√≤ t·ª≠ cung
            const contraction = document.querySelector('input[name="uterine_contraction"]:checked')?.value;
            if (contraction === 'normal') summaryText += '‚Ä¢ G√≤ t·ª≠ cung: < 5 c∆°n/10 ph√∫t\n';
            else if (contraction === 'suspicious') summaryText += '‚Ä¢ G√≤ t·ª≠ cung: ‚â• 5 c∆°n/10 ph√∫t\n';
            else if (contraction === 'prolonged') summaryText += '‚Ä¢ G√≤ t·ª≠ cung: K√©o d√†i ‚â• 2 ph√∫t\n';
            
            // Tim thai cƒÉn b·∫£n
            const baseline = formData.baseline_fhr;
            if (baseline) {
                summaryText += `‚Ä¢ Tim thai cƒÉn b·∫£n: ${baseline} bpm`;
                if (formData.baseline_stable === 'yes') summaryText += ' (·ªïn ƒë·ªãnh)';
                else if (formData.baseline_100_109_type) summaryText += ` (${formData.baseline_100_109_type === 'new' ? 'm·ªõi xu·∫•t hi·ªán' : 'ƒë√£ c√≥ t·ª´ tr∆∞·ªõc'})`;
                summaryText += '\n';
            }
            
            // Dao ƒë·ªông n·ªôi t·∫°i
            const variability = formData.variability;
            if (variability) {
                let varText = '‚Ä¢ Dao ƒë·ªông n·ªôi t·∫°i: ';
                if (variability === 'moderate') varText += '6-25 bpm (b√¨nh th∆∞·ªùng)';
                else if (variability === 'minimal') varText += '3-5 bpm (gi·∫£m)';
                else if (variability === 'marked') varText += '>25 bpm (tƒÉng)';
                else if (variability === 'undetectable') varText += 'Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c';
                else if (variability === 'sinusoidal') varText += 'D·∫°ng h√¨nh sin';
                summaryText += varText + '\n';
            }
            
            // Nh·ªãp gi·∫£m
            const decelerations = formData.decelerations || [];
            if (decelerations.length > 0) {
                if (decelerations.includes('none')) {
                    summaryText += '‚Ä¢ Nh·ªãp gi·∫£m: Kh√¥ng c√≥\n';
                } else {
                    let types = [];
                    if (decelerations.includes('early')) types.push('s·ªõm');
                    if (decelerations.includes('variable')) types.push('b·∫•t ƒë·ªãnh');
                    if (decelerations.includes('late')) types.push('mu·ªôn');
                    if (decelerations.includes('prolonged')) types.push('k√©o d√†i');
                    summaryText += `‚Ä¢ Nh·ªãp gi·∫£m: ${types.join(', ')}\n`;
                }
            }
            
            // Nh·ªãp tƒÉng
            if (formData.acceleration) {
                summaryText += `‚Ä¢ Nh·ªãp tƒÉng: ${formData.acceleration === 'present' ? 'C√≥' : 'Kh√¥ng c√≥'}\n`;
            }
            
            const summaryLines = doc.splitTextToSize(summaryText, maxWidth);
            doc.text(summaryLines, margin, yPosition);
            yPosition += summaryLines.length * 5 + 10;
            
            // Ki·ªÉm tra trang m·ªõi
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            // K·∫øt qu·∫£ ph√¢n t√≠ch
            doc.setFontSize(14);
            doc.text('2. K·∫æT QU·∫¢ PH√ÇN T√çCH', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(10);
            
            Object.values(analysisResults).forEach((result, index) => {
                // Ki·ªÉm tra n·∫øu c·∫ßn trang m·ªõi
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${result.system}:`, margin, yPosition);
                yPosition += 8;
                
                doc.setFontSize(11);
                doc.text(`K·∫øt lu·∫≠n: ${result.classification}`, margin + 5, yPosition);
                yPosition += 8;
                
                doc.setFontSize(9);
                result.details.forEach(detail => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    const cleanDetail = detail.replace(/[üü¢üü°üî¥‚ö†Ô∏èüìãüîß‚úì‚Üí]/g, '');
                    const lines = doc.splitTextToSize('- ' + cleanDetail, maxWidth - 10);
                    doc.text(lines, margin + 5, yPosition);
                    yPosition += lines.length * 4 + 2;
                });
                
                yPosition += 5;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Trang ${i}/${pageCount}`, pageWidth - margin, doc.internal.pageSize.height - 10, { align: 'right' });
                doc.text('T·∫°o b·ªüi CTG Analyzer', margin, doc.internal.pageSize.height - 10);
            }
            
            // L∆∞u file
            const fileName = `CTG_Analysis_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(fileName);
        }
        
        // Initialize radio button styling
        document.addEventListener('change', function(e) {
            if (e.target.type === 'radio') {
                // Remove selected class from all radio items with the same name
                document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(radio => {
                    radio.closest('.radio-item').classList.remove('selected');
                });
                // Add selected class to the checked radio item
                e.target.closest('.radio-item').classList.add('selected');
            } else if (e.target.type === 'checkbox') {
                // Toggle selected class for checkboxes
                if (e.target.checked) {
                    e.target.closest('.checkbox-item').classList.add('selected');
                } else {
                    e.target.closest('.checkbox-item').classList.remove('selected');
                }
            }
        });
    </script>
</body>
</html>
