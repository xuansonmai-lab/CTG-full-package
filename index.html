import React, { useState, useEffect } from 'react';
import { ChevronDown, ChevronRight, FileText, AlertTriangle, CheckCircle } from 'lucide-react';

const CTGAnalyzer = () => {
  const [uterineContractions, setUterineContractions] = useState('');
  const [baselineFHR, setBaselineFHR] = useState('');
  const [baselineStable, setBaselineStable] = useState('');
  const [baselineIncrease10Percent, setBaselineIncrease10Percent] = useState('');
  const [baselineIncrease20Bpm, setBaselineIncrease20Bpm] = useState('');
  const [variability, setVariability] = useState('');
  const [variabilityDuration, setVariabilityDuration] = useState('');
  const [decelerations, setDecelerations] = useState('');
  const [variableRepetitive, setVariableRepetitive] = useState('');
  const [variableOminousFeatures, setVariableOminousFeatures] = useState('');
  const [variableDuration, setVariableDuration] = useState('');
  const [variableSeverity, setVariableSeverity] = useState('');
  const [lateSeverity, setLateSeverity] = useState('');
  const [prolongedSeverity, setProlongedSeverity] = useState('');
  const [accelerations, setAccelerations] = useState('');
  const [accelerationsLostAfterDecel, setAccelerationsLostAfterDecel] = useState('');
  const [timeInDecelVsBaseline, setTimeInDecelVsBaseline] = useState('');
  
  const [results, setResults] = useState(null);
  const [showResults, setShowResults] = useState(false);

  // Analyze function
  const analyzeCtg = () => {
    if (!uterineContractions || !baselineFHR || !variability || !decelerations) {
      alert('Vui lòng điền đầy đủ các thông số cơ bản');
      return;
    }

    // Additional validation for sub-questions based on selections
    if (decelerations === 'variable' && !variableSeverity) {
      alert('Vui lòng chọn mức độ nghiêm trọng của nhịp giảm bất định');
      return;
    }
    if (decelerations === 'late' && !lateSeverity) {
      alert('Vui lòng chọn mức độ nghiêm trọng của nhịp giảm muộn');
      return;
    }
    if (decelerations === 'prolonged' && !prolongedSeverity) {
      alert('Vui lòng chọn mức độ nghiêm trọng của nhịp giảm kéo dài');
      return;
    }
    
    // Validation for baseline questions
    if (baselineFHR === '110-160' && baselineStable === 'no' && !baselineIncrease10Percent) {
      alert('Vui lòng chọn có tăng ≥10% so với băng ghi trước đó không');
      return;
    }
    if (baselineIncrease10Percent === 'yes' && !baselineIncrease20Bpm) {
      alert('Vui lòng chọn có tăng ≥20 bpm so với băng ghi trước đó không');
      return;
    }
    
    // Validation for time in deceleration vs baseline
    if (decelerations !== 'none' && decelerations !== '' && decelerations !== 'early' && !timeInDecelVsBaseline) {
      alert('Vui lòng chọn thời gian thai trong nhịp giảm so với thời gian ở tim thai căn bản');
      return;
    }

    const analysis = {
      nice2022: calculateNICE2022(),
      acog2009: calculateACOG2009(),
      figo2015: calculateFIGO2015(),
      rcog2001: calculateRCOG2001(),
      pathophysiology: calculatePathophysiology(),
      japanese: calculateJapanese()
    };

    setResults(analysis);
    setShowResults(true);
  };

  // NICE 2022 Classification
  const calculateNICE2022 = () => {
    let redFlags = 0;
    let yellowFlags = 0;

    // Uterine contractions
    if (uterineContractions === '>5_per_10min') yellowFlags++;

    // Baseline FHR
    if (baselineFHR === '<100' || baselineFHR === '>160') redFlags++;
    else if (baselineFHR === '100-109' || (baselineFHR === '110-160' && baselineIncrease === 'yes')) yellowFlags++;

    // Variability
    if (variability === '<5_minimal' && variabilityDuration === '>50min') redFlags++;
    else if (variability === '>25_marked' && variabilityDuration === '>10min') redFlags++;
    else if (variability === 'sinusoidal') redFlags++;
    else if (variability === '<5_minimal' && variabilityDuration === '30-50min') yellowFlags++;
    else if (variability === '>25_marked' && variabilityDuration === '<10min') yellowFlags++;

    // Decelerations
    if (decelerations === 'variable' && variableRepetitive === 'yes' && variableOminousFeatures === 'yes' && variableDuration === '>=30min') redFlags++;
    else if (decelerations === 'late' && variableRepetitive === 'yes' && variableDuration === '>=30min') redFlags++;
    else if (decelerations === 'prolonged' && variableDuration === '>3min') redFlags++;
    else if (decelerations === 'variable' && variableRepetitive === 'yes' && variableOminousFeatures === 'yes' && variableDuration === '<30min') yellowFlags++;
    else if (decelerations === 'late' && variableRepetitive === 'yes' && variableDuration === '<30min') yellowFlags++;

    if (redFlags >= 1 || yellowFlags >= 2) return { category: 'Bất thường', color: 'text-red-600', action: 'Đánh giá toàn diện, hồi sức, cân nhắc can thiệp ngay' };
    if (yellowFlags === 1) return { category: 'Nghi ngờ', color: 'text-yellow-600', action: 'Đánh giá toàn diện, theo dõi sát, cân nhắc can thiệp' };
    return { category: 'Bình thường', color: 'text-green-600', action: 'Tiếp tục theo dõi' };
  };

  // ACOG 2009 Classification
  const calculateACOG2009 = () => {
    // Group III criteria
    if (variability === 'absent' && (
      (decelerations === 'late' && variableRepetitive === 'yes') || 
      (decelerations === 'variable' && variableRepetitive === 'yes') || 
      baselineFHR === '<100'
    )) {
      return { category: 'Nhóm III', color: 'text-red-600', action: 'Can thiệp ngay lập tức' };
    }
    if (variability === 'sinusoidal') {
      return { category: 'Nhóm III', color: 'text-red-600', action: 'Can thiệp ngay lập tức' };
    }

    // Group I criteria
    if (baselineFHR === '110-160' && 
        variability === '5-25' && 
        decelerations !== 'late' && 
        decelerations !== 'variable') {
      return { category: 'Nhóm I', color: 'text-green-600', action: 'Tiếp tục quan sát' };
    }

    return { category: 'Nhóm II', color: 'text-yellow-600', action: 'Theo dõi sát, đánh giá thêm' };
  };

  // FIGO 2015 Classification
  const calculateFIGO2015 = () => {
    let pathological = false;
    let suspicious = false;

    // Baseline - FIGO uses <100 bpm as pathological
    if (baselineFHR === '<80' || baselineFHR === '80-100') pathological = true;
    else if (baselineFHR !== '110-160') suspicious = true;

    // Variability
    if (variability === 'absent' || variability === '>25_marked' || variability === 'sinusoidal') pathological = true;
    else if (variability !== '5-25') suspicious = true;

    // Decelerations
    if ((decelerations === 'late' && variableRepetitive === 'yes' && variableDuration === '>=30min') || 
        (decelerations === 'prolonged' && variableDuration === '>3min')) pathological = true;
    else if (decelerations !== 'none' && decelerations !== 'early') suspicious = true;

    if (pathological) return { category: 'Bệnh lý', color: 'text-red-600', action: 'Hành động ngay để khắc phục thiếu oxy' };
    if (suspicious) return { category: 'Nghi ngờ', color: 'text-yellow-600', action: 'Xác định nguyên nhân, theo dõi sát' };
    return { category: 'Bình thường', color: 'text-green-600', action: 'Không cần can thiệp' };
  };

  // RCOG 2001 Classification
  const calculateRCOG2001 = () => {
    let abnormal = false;
    let suspicious = false;

    // Baseline - RCOG uses <100 and >180 as abnormal
    if (baselineFHR === '<80' || baselineFHR === '80-100' || baselineFHR === '>180') abnormal = true;
    else if (baselineFHR === '100-109' || baselineFHR === '160-180') suspicious = true;

    // Variability
    if ((variability === '<5_minimal' && variabilityDuration === '>90min') || variability === 'sinusoidal') abnormal = true;
    else if (variability === '<5_minimal' && (variabilityDuration === '30-50min' || variabilityDuration === '>50min')) suspicious = true;

    // Decelerations
    if (decelerations === 'late' || 
        (decelerations === 'variable' && variableSeverity === 'severe') ||
        (decelerations === 'prolonged' && variableDuration === '>3min')) abnormal = true;
    else if (decelerations === 'variable' || 
             (decelerations === 'prolonged' && variableDuration === '2-3min')) suspicious = true;

    if (abnormal) return { category: 'Bất thường', color: 'text-red-600', action: 'Can thiệp ngay lập tức' };
    if (suspicious) return { category: 'Nghi ngờ', color: 'text-yellow-600', action: 'Theo dõi sát hơn' };
    return { category: 'Bình thường', color: 'text-green-600', action: 'Tiếp tục quan sát' };
  };

  // Pathophysiology Classification
  const calculatePathophysiology = () => {
    // Acute hypoxia - Nhịp giảm kéo dài
    if (decelerations === 'prolonged') {
      return { category: 'Thiếu Oxy Cấp', color: 'text-red-600', action: 'Loại trừ tai biến, mổ ngay nếu cần' };
    }
    
    // Subacute hypoxia - Thời gian trong nhịp giảm > thời gian ở TTCB
    if (timeInDecelVsBaseline === 'deceleration_longer') {
      return { category: 'Thiếu Oxy Bán Cấp', color: 'text-red-600', action: 'Ngưng oxytocin, đánh giá can thiệp' };
    }

    // Check for evolving hypoxia indicators
    const hasBaselineIncrease = baselineIncrease10Percent === 'yes' || 
                                baselineFHR === '160-180' || 
                                baselineFHR === '>180';
    
    const hasAbnormalVariability = variability === '<5_minimal' || 
                                   variability === 'absent' || 
                                   variability === '>25_marked';
    
    const hasRepetitiveDecelerations = (decelerations === 'variable' && variableRepetitive === 'yes') ||
                                       (decelerations === 'late' && variableRepetitive === 'yes');

    // Evolving hypoxia - decompensated
    if (hasBaselineIncrease && hasAbnormalVariability && hasRepetitiveDecelerations) {
      return { category: 'Thiếu Oxy Diễn Tiến - Mất Bù', color: 'text-red-600', action: 'Ngưng oxytocin, cân nhắc mổ' };
    }
    
    // Evolving hypoxia - compensated (multiple indicators)
    let compensatedIndicators = [];
    
    // 1. Baseline increase (10% increase is a sign)
    if (baselineIncrease10Percent === 'yes') {
      compensatedIndicators.push('Tăng tim thai căn bản ≥10%');
    }
    
    // 2. Time in baseline > time in deceleration
    if (timeInDecelVsBaseline === 'baseline_longer') {
      compensatedIndicators.push('Thời gian ở TTCB > thời gian nhịp giảm');
    }
    
    // 3. Loss of accelerations after decelerations
    if (accelerationsLostAfterDecel === 'yes') {
      compensatedIndicators.push('Mất nhịp tăng sau nhịp giảm');
    }
    
    if (compensatedIndicators.length > 0) {
      return { 
        category: 'Thiếu Oxy Diễn Tiến - Còn Bù', 
        color: 'text-yellow-600', 
        action: `Theo dõi 30-60 phút. Dấu hiệu: ${compensatedIndicators.join(', ')}` 
      };
    }

    return { category: 'Không xác định được', color: 'text-gray-600', action: 'Cần đánh giá thêm' };
  };

  // Japanese Classification (simplified)
  const calculateJapanese = () => {
    let level = 1;

    // Baseline assessment
    if (baselineFHR === '160-180') level = Math.max(level, 2);
    else if (baselineFHR === '80-100') level = Math.max(level, 3);
    else if (baselineFHR === '<80') level = Math.max(level, 4);
    else if (baselineFHR === '>180') level = Math.max(level, 4);

    // Variability assessment
    if (variability === '<5_minimal') level = Math.max(level, 3);
    else if (variability === 'absent') level = Math.max(level, 4);

    // Deceleration assessment based on type and severity
    if (decelerations === 'early') level = Math.max(level, 2);
    else if (decelerations === 'variable') {
      if (variableSeverity === 'mild') level = Math.max(level, 2);
      else if (variableSeverity === 'severe') level = Math.max(level, 3);
    }
    else if (decelerations === 'late') {
      if (lateSeverity === 'mild') level = Math.max(level, 3);
      else if (lateSeverity === 'severe') level = Math.max(level, 4);
    }
    else if (decelerations === 'prolonged') {
      if (prolongedSeverity === 'mild') level = Math.max(level, 3);
      else if (prolongedSeverity === 'severe') level = Math.max(level, 4);
    }

    // Additional combinations that increase level
    if (level >= 3 && (variability === '<5_minimal' || variability === 'absent')) {
      level = Math.max(level, 4);
    }
    if (level >= 4 && variability === 'absent') {
      level = 5;
    }

    const categories = {
      1: { category: 'Mức 1', color: 'text-green-600' },
      2: { category: 'Mức 2', color: 'text-green-500' },
      3: { category: 'Mức 3', color: 'text-yellow-600' },
      4: { category: 'Mức 4', color: 'text-orange-600' },
      5: { category: 'Mức 5', color: 'text-red-600' }
    };

    return categories[level] || categories[1];
  };

  return (
    <div className="max-w-4xl mx-auto p-6 bg-white">
      <div className="mb-8 text-center">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">
          <FileText className="inline-block mr-2" />
          Công cụ Phân tích CTG Đa chiều
        </h1>
        <p className="text-gray-600">Phân tích CTG theo nhiều hệ thống phân loại quốc tế</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Input Section */}
        <div className="space-y-6">
          <div className="bg-blue-50 p-4 rounded-lg">
            <h2 className="text-xl font-semibold text-blue-800 mb-4">Thông số CTG</h2>
            
            {/* Uterine Contractions */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                1. Gò tử cung (cơn/10 phút)
              </label>
              <select 
                value={uterineContractions} 
                onChange={(e) => setUterineContractions(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Chọn...</option>
                <option value="<5_per_10min">{'< 5 cơn/10 phút'}</option>
                <option value=">5_per_10min">{'≥ 5 cơn/10 phút hoặc cơn kéo dài ≥ 2 phút'}</option>
              </select>
            </div>

            {/* Baseline FHR */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                2. Tim thai căn bản (bpm)
              </label>
              <select 
                value={baselineFHR} 
                onChange={(e) => setBaselineFHR(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Chọn...</option>
                <option value="<80">{'< 80 bpm'}</option>
                <option value="80-100">80-100 bpm</option>
                <option value="100-109">100-109 bpm</option>
                <option value="110-160">110-160 bpm</option>
                <option value="160-180">160-180 bpm</option>
                <option value=">180">{'> 180 bpm'}</option>
              </select>
              
              {baselineFHR === '110-160' && (
                <div className="mt-2 space-y-2">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Tim thai có ổn định và phù hợp tuổi thai?
                    </label>
                    <select 
                      value={baselineStable} 
                      onChange={(e) => setBaselineStable(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="yes">Có</option>
                      <option value="no">Không</option>
                    </select>
                  </div>
                  
                  {baselineStable === 'no' && (
                    <>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">
                          Có tăng ≥ 10% so với băng ghi trước đó?
                        </label>
                        <select 
                          value={baselineIncrease10Percent} 
                          onChange={(e) => setBaselineIncrease10Percent(e.target.value)}
                          className="w-full p-1 text-sm border border-gray-300 rounded"
                        >
                          <option value="">Chọn...</option>
                          <option value="yes">Có</option>
                          <option value="no">Không</option>
                        </select>
                      </div>
                      
                      {baselineIncrease10Percent === 'yes' && (
                        <div>
                          <label className="block text-xs text-gray-600 mb-1">
                            Có tăng ≥ 20 bpm so với băng ghi trước đó? (NICE)
                          </label>
                          <select 
                            value={baselineIncrease20Bpm} 
                            onChange={(e) => setBaselineIncrease20Bpm(e.target.value)}
                            className="w-full p-1 text-sm border border-gray-300 rounded"
                          >
                            <option value="">Chọn...</option>
                            <option value="yes">Có</option>
                            <option value="no">Không</option>
                          </select>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}

              {(baselineFHR === '160-180' || baselineFHR === '>180') && (
                <div className="mt-2">
                  <label className="block text-xs text-gray-600 mb-1">
                    Có tăng ≥ 10% so với băng ghi trước đó?
                  </label>
                  <select 
                    value={baselineIncrease10Percent} 
                    onChange={(e) => setBaselineIncrease10Percent(e.target.value)}
                    className="w-full p-1 text-sm border border-gray-300 rounded"
                  >
                    <option value="">Chọn...</option>
                    <option value="yes">Có</option>
                    <option value="no">Không</option>
                  </select>
                </div>
              )}
            </div>

            {/* Variability */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                3. Dao động nội tại (bpm)
              </label>
              <select 
                value={variability} 
                onChange={(e) => setVariability(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Chọn...</option>
                <option value="absent">Không có ({'< 3 bpm'})</option>
                <option value="<5_minimal">Tối thiểu (3-5 bpm)</option>
                <option value="5-25">Bình thường (5-25 bpm)</option>
                <option value=">25_marked">Tăng cao ({'>25 bpm'})</option>
                <option value="sinusoidal">Dạng hình sin</option>
              </select>

              {variability === '<5_minimal' && (
                <div className="mt-2">
                  <label className="block text-xs text-gray-600 mb-1">
                    Kéo dài bao lâu?
                  </label>
                  <select 
                    value={variabilityDuration} 
                    onChange={(e) => setVariabilityDuration(e.target.value)}
                    className="w-full p-1 text-sm border border-gray-300 rounded"
                  >
                    <option value="">Chọn...</option>
                    <option value="<30min">{'< 30 phút'}</option>
                    <option value="30-50min">30-50 phút</option>
                    <option value=">50min">{'> 50 phút'}</option>
                    <option value=">90min">{'> 90 phút'}</option>
                  </select>
                </div>
              )}

              {variability === '>25_marked' && (
                <div className="mt-2">
                  <label className="block text-xs text-gray-600 mb-1">
                    Kéo dài bao lâu?
                  </label>
                  <select 
                    value={variabilityDuration} 
                    onChange={(e) => setVariabilityDuration(e.target.value)}
                    className="w-full p-1 text-sm border border-gray-300 rounded"
                  >
                    <option value="">Chọn...</option>
                    <option value="<10min">{'< 10 phút'}</option>
                    <option value=">10min">{'> 10 phút'}</option>
                  </select>
                </div>
              )}
            </div>

            {/* Decelerations */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                4. Nhịp giảm
              </label>
              <select 
                value={decelerations} 
                onChange={(e) => {
                  setDecelerations(e.target.value);
                  // Reset sub-options when main option changes
                  setVariableRepetitive('');
                  setVariableOminousFeatures('');
                  setVariableDuration('');
                  setVariableSeverity('');
                  setLateSeverity('');
                  setProlongedSeverity('');
                  setTimeInDecelVsBaseline('');
                  setAccelerationsLostAfterDecel('');
                }}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Chọn...</option>
                <option value="none">Không có</option>
                <option value="early">Nhịp giảm sớm</option>
                <option value="variable">Nhịp giảm bất định (biến đổi)</option>
                <option value="late">Nhịp giảm muộn</option>
                <option value="prolonged">Nhịp giảm kéo dài</option>
              </select>

              {/* Variable deceleration sub-questions */}
              {decelerations === 'variable' && (
                <div className="mt-2 space-y-2 pl-4 border-l-2 border-gray-200">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Có lặp lại không?
                    </label>
                    <select 
                      value={variableRepetitive} 
                      onChange={(e) => setVariableRepetitive(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="yes">Có lặp lại</option>
                      <option value="no">Không lặp lại</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Có đặc điểm đáng ngại? (kéo dài {'>60s'}, giảm dao động trong nhịp giảm, mất dạng vai)
                    </label>
                    <select 
                      value={variableOminousFeatures} 
                      onChange={(e) => setVariableOminousFeatures(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="yes">Có</option>
                      <option value="no">Không</option>
                    </select>
                  </div>

                  {variableRepetitive === 'yes' && variableOminousFeatures === 'yes' && (
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">
                        Thời gian xuất hiện:
                      </label>
                      <select 
                        value={variableDuration} 
                        onChange={(e) => setVariableDuration(e.target.value)}
                        className="w-full p-1 text-sm border border-gray-300 rounded"
                      >
                        <option value="">Chọn...</option>
                        <option value="<30min">{'< 30 phút'}</option>
                        <option value=">=30min">{'≥ 30 phút'}</option>
                      </select>
                    </div>
                  )}

                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Mức độ nghiêm trọng:
                    </label>
                    <select 
                      value={variableSeverity} 
                      onChange={(e) => setVariableSeverity(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="mild">Nhẹ</option>
                      <option value="severe">Nặng (điểm thấp nhất {'<70 bpm'} và {'>'} 30s hoặc 70-80 bpm và {'>'} 60s)</option>
                    </select>
                  </div>
                </div>
              )}

              {/* Late deceleration sub-questions */}
              {decelerations === 'late' && (
                <div className="mt-2 space-y-2 pl-4 border-l-2 border-gray-200">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Có lặp lại không?
                    </label>
                    <select 
                      value={variableRepetitive} 
                      onChange={(e) => setVariableRepetitive(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="yes">Có lặp lại</option>
                      <option value="no">Không lặp lại</option>
                    </select>
                  </div>

                  {variableRepetitive === 'yes' && (
                    <div>
                      <label className="block text-xs text-gray-600 mb-1">
                        Thời gian lặp lại:
                      </label>
                      <select 
                        value={variableDuration} 
                        onChange={(e) => setVariableDuration(e.target.value)}
                        className="w-full p-1 text-sm border border-gray-300 rounded"
                      >
                        <option value="">Chọn...</option>
                        <option value="<30min">{'< 30 phút'}</option>
                        <option value=">=30min">{'≥ 30 phút'}</option>
                      </select>
                    </div>
                  )}

                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Mức độ nghiêm trọng:
                    </label>
                    <select 
                      value={lateSeverity} 
                      onChange={(e) => setLateSeverity(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="mild">Nhẹ</option>
                      <option value="severe">Nặng (nhịp giảm {'>'} 15 bpm từ NTTCB đến điểm thấp nhất)</option>
                    </select>
                  </div>
                </div>
              )}

              {/* Prolonged deceleration sub-questions */}
              {decelerations === 'prolonged' && (
                <div className="mt-2 space-y-2 pl-4 border-l-2 border-gray-200">
                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Thời gian kéo dài:
                    </label>
                    <select 
                      value={variableDuration} 
                      onChange={(e) => setVariableDuration(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="2-3min">2-3 phút</option>
                      <option value=">3min">{'> 3 phút'}</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-xs text-gray-600 mb-1">
                      Mức độ nghiêm trọng:
                    </label>
                    <select 
                      value={prolongedSeverity} 
                      onChange={(e) => setProlongedSeverity(e.target.value)}
                      className="w-full p-1 text-sm border border-gray-300 rounded"
                    >
                      <option value="">Chọn...</option>
                      <option value="mild">Nhẹ</option>
                      <option value="severe">Nặng (điểm thấp nhất {'< 80 bpm'})</option>
                    </select>
                  </div>
                </div>
              )}
            </div>

            {/* Accelerations */}
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                5. Nhịp tăng
              </label>
              <select 
                value={accelerations} 
                onChange={(e) => setAccelerations(e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Chọn...</option>
                <option value="present">Có</option>
                <option value="absent">Không có</option>
              </select>
              
              {accelerations === 'present' && (decelerations !== 'none' && decelerations !== '') && (
                <div className="mt-2">
                  <label className="block text-xs text-gray-600 mb-1">
                    Có biến mất sau khi có nhịp giảm không?
                  </label>
                  <select 
                    value={accelerationsLostAfterDecel} 
                    onChange={(e) => setAccelerationsLostAfterDecel(e.target.value)}
                    className="w-full p-1 text-sm border border-gray-300 rounded"
                  >
                    <option value="">Chọn...</option>
                    <option value="yes">Có</option>
                    <option value="no">Không</option>
                  </select>
                </div>
              )}
            </div>

            {/* Time in deceleration vs baseline question */}
            {(decelerations !== 'none' && decelerations !== '' && decelerations !== 'early') && (
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  6. Thời gian thai trong nhịp giảm so với thời gian ở tim thai căn bản
                </label>
                <select 
                  value={timeInDecelVsBaseline} 
                  onChange={(e) => setTimeInDecelVsBaseline(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">Chọn...</option>
                  <option value="baseline_longer">Thời gian ở TTCB dài hơn</option>
                  <option value="deceleration_longer">Thời gian trong nhịp giảm dài hơn</option>
                  <option value="equal">Tương đương nhau</option>
                </select>
              </div>
            )}

            <button 
              onClick={analyzeCtg}
              className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium"
            >
              Phân tích CTG
            </button>
          </div>
        </div>

        {/* Results Section */}
        <div className="space-y-4">
          {showResults && results && (
            <div className="bg-gray-50 p-4 rounded-lg">
              <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <AlertTriangle className="mr-2" />
                Kết quả Phân tích
              </h2>
              
              <div className="space-y-3">
                <div className="bg-white p-3 rounded border-l-4 border-blue-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">NICE 2022:</span>
                    <span className={`font-bold ${results.nice2022.color}`}>
                      {results.nice2022.category}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mt-1">{results.nice2022.action}</p>
                </div>

                <div className="bg-white p-3 rounded border-l-4 border-green-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">ACOG 2009:</span>
                    <span className={`font-bold ${results.acog2009.color}`}>
                      {results.acog2009.category}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mt-1">{results.acog2009.action}</p>
                </div>

                <div className="bg-white p-3 rounded border-l-4 border-purple-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">FIGO 2015:</span>
                    <span className={`font-bold ${results.figo2015.color}`}>
                      {results.figo2015.category}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mt-1">{results.figo2015.action}</p>
                </div>

                <div className="bg-white p-3 rounded border-l-4 border-red-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">RCOG 2001:</span>
                    <span className={`font-bold ${results.rcog2001.color}`}>
                      {results.rcog2001.category}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mt-1">{results.rcog2001.action}</p>
                </div>

                <div className="bg-white p-3 rounded border-l-4 border-orange-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">Phân loại Sinh lý:</span>
                    <span className={`font-bold ${results.pathophysiology.color}`}>
                      {results.pathophysiology.category}
                    </span>
                  </div>
                  <p className="text-sm text-gray-600 mt-1">{results.pathophysiology.action}</p>
                </div>

                <div className="bg-white p-3 rounded border-l-4 border-pink-500">
                  <div className="flex justify-between items-center">
                    <span className="font-medium">Phân loại Nhật Bản:</span>
                    <span className={`font-bold ${results.japanese.color}`}>
                      {results.japanese.category}
                    </span>
                  </div>
                </div>
              </div>

              <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-sm text-yellow-800">
                  <strong>Lưu ý:</strong> Kết quả này chỉ mang tính chất tham khảo. 
                  Quyết định lâm sàng cuối cùng phải dựa trên đánh giá toàn diện của bác sĩ.
                </p>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default CTGAnalyzer;
